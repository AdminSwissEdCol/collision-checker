<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Collision Checker - Swiss Educational College</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #c8102e;
        }
        .header h1 { color: #c8102e; margin-bottom: 5px; font-size: 1.8em; }
        .header .subtitle { color: #666; font-size: 1.1em; }
        
        .step {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 5px solid #e0e0e0;
            transition: all 0.3s;
        }
        .step.active { border-left-color: #4285f4; }
        .step.complete { border-left-color: #34a853; background: #f8fff8; }
        .step.error { border-left-color: #ea4335; }
        
        .step-header { display: flex; align-items: center; margin-bottom: 15px; }
        .step-number {
            width: 36px; height: 36px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.1em;
            margin-right: 15px;
        }
        .step.active .step-number { background: #4285f4; color: white; }
        .step.complete .step-number { background: #34a853; color: white; }
        .step.complete .step-number::after { content: "‚úì"; }
        .step.complete .step-number span { display: none; }
        
        .step-title { font-size: 1.1em; font-weight: 600; color: #333; }
        .step-content { margin-left: 51px; }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            border: none;
            margin: 5px 5px 5px 0;
            transition: all 0.2s;
        }
        .btn-primary { background: #4285f4; color: white; }
        .btn-primary:hover { background: #3367d6; }
        .btn-success { background: #34a853; color: white; }
        .btn-success:hover { background: #2d8e47; }
        .btn-large { font-size: 16px; padding: 15px 30px; }
        .btn:disabled { background: #ccc !important; cursor: not-allowed; }
        .btn-secondary { background: #f1f3f4; color: #333; }
        .btn-secondary:hover { background: #e0e0e0; }
        .btn-purple { background: #7c4dff; color: white; }
        .btn-purple:hover { background: #651fff; }
        
        .upload-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #4285f4;
            background: #e8f0fe;
        }
        .upload-zone input { display: none; }
        .upload-zone .icon { font-size: 2em; margin-bottom: 10px; }
        
        .status {
            margin: 10px 0;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 14px;
        }
        .status.info { background: #e8f0fe; color: #1967d2; }
        .status.success { background: #e6f4ea; color: #137333; }
        .status.error { background: #fce8e6; color: #c5221f; }
        .status.warning { background: #fef7e0; color: #b06000; }
        .status:empty { display: none; }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .input-group input, .input-group select {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #4285f4;
        }
        
        .stats { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .stat {
            background: #f1f3f4;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .results-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-top: 20px;
        }
        .results-box h2 { margin: 0 0 10px 0; }
        .results-box .count { font-size: 3em; font-weight: bold; margin: 15px 0; }
        .results-box a {
            display: inline-block;
            background: white;
            color: #667eea;
            padding: 12px 30px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 10px;
        }
        .results-box a:hover { transform: scale(1.05); }
        .results-box.no-collisions { background: linear-gradient(135deg, #34a853 0%, #0d652d 100%); }
        .results-box.no-collisions a { color: #34a853; }
        
        .info-box {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 12px 15px;
            border-radius: 0 6px 6px 0;
            margin: 15px 0;
            font-size: 13px;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
        }
        
        details summary { cursor: pointer; color: #666; font-size: 13px; margin: 10px 0; }
        
        .help-section {
            margin-top: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0;
        }
        .help-section summary {
            padding: 12px 15px;
            margin: 0;
            background: #f1f3f4;
            border-radius: 8px;
        }
        .help-section[open] summary {
            border-radius: 8px 8px 0 0;
        }
        .help-content {
            padding: 15px;
            font-size: 13px;
        }
        .help-content h4 {
            margin: 15px 0 8px 0;
            color: #333;
            font-size: 13px;
        }
        .help-content h4:first-child { margin-top: 0; }
        .help-content ul {
            margin: 0;
            padding-left: 20px;
        }
        .help-content li { margin: 4px 0; }
        .help-content code {
            background: #e8e8e8;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }
        .help-table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
        }
        .help-table td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top;
        }
        .help-table td:first-child {
            width: 140px;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .table-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-top: 10px;
        }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; }
        
        .level-badge {
            display: inline-block; padding: 2px 8px; border-radius: 10px;
            font-size: 10px; font-weight: 500;
        }
        .level-English { background: #e3f2fd; color: #1565c0; }
        .level-Certificate { background: #fce8e6; color: #c5221f; }
        .level-Diploma { background: #e8f0fe; color: #1967d2; }
        .level-High-Diploma { background: #fef7e0; color: #b06000; }
        .level-BBA { background: #e6f4ea; color: #137333; }
        .level-PGD { background: #f3e8fd; color: #7627bb; }
        .level-MBA { background: #fce8f4; color: #b80672; }
        .level-CUL-I, .level-CUL-II, .level-CUL-III, .level-CUL { background: #fff3e0; color: #e65100; }
        .level-Internship { background: #e0e0e0; color: #555; }
        
        @media (max-width: 600px) {
            .step-content { margin-left: 0; margin-top: 15px; }
            .input-group { flex-direction: column; }
        }
        
        /* ========== PROGRESSION PREDICTOR STYLES ========== */
        
        .hidden-feature {
            display: none;
        }
        .hidden-feature.visible {
            display: block;
        }
        
        .progression-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            border: 2px solid #7c4dff;
            margin-top: 30px;
        }
        .progression-section .step-number {
            background: #7c4dff;
            color: white;
        }
        
        .track-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        .track-tab {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .track-tab.active {
            background: #7c4dff;
            color: white;
            border-color: #7c4dff;
        }
        
        .progression-visual {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin: 15px 0;
            align-items: center;
        }
        .prog-step {
            text-align: center;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            min-width: 70px;
        }
        .prog-arrow {
            color: #999;
            font-size: 16px;
        }
        .prog-degree {
            font-size: 14px;
        }
        
        .prediction-results {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .prediction-group {
            margin-bottom: 20px;
        }
        .prediction-group h4 {
            margin: 0 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .prediction-group h4 .count {
            background: #f1f3f4;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        .prediction-group.continuing h4 { color: #1967d2; border-color: #1967d2; }
        .prediction-group.returning h4 { color: #137333; border-color: #137333; }
        .prediction-group.internship h4 { color: #666; border-color: #999; }
        .prediction-group.graduating h4 { color: #7627bb; border-color: #7627bb; }
        .prediction-group.optional h4 { color: #b06000; border-color: #ffc107; }
        .prediction-group.failed h4 { color: #c5221f; border-color: #c5221f; }
        
        .student-list {
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }
        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background: #f9f9f9;
            margin: 3px 0;
            border-radius: 4px;
            gap: 10px;
        }
        .student-item .name { font-weight: 500; min-width: 120px; }
        .student-item .email { color: #666; flex: 1; font-size: 11px; }
        .student-item .status-tag {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
        }
        .student-item .status-tag.term1 { background: #e8f0fe; color: #1967d2; }
        .student-item .status-tag.term2 { background: #e6f4ea; color: #137333; }
        .student-item .status-tag.failed { background: #fce8e6; color: #c5221f; }
        
        .term-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .term-selector label {
            font-weight: 500;
        }
        .term-selector select, .term-selector input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .export-btn {
            background: #34a853;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin: 5px;
        }
        .export-btn:hover {
            background: #2d8e47;
        }
        
        .progression-timeline {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            overflow-x: auto;
        }
        .timeline-row {
            display: flex;
            gap: 4px;
            margin: 8px 0;
            align-items: center;
        }
        .timeline-label {
            width: 80px;
            font-size: 11px;
            font-weight: 500;
            flex-shrink: 0;
        }
        .timeline-cell {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            text-align: center;
            min-width: 65px;
        }
        .timeline-cell.class { background: #e8f0fe; }
        .timeline-cell.internship { background: #f1f3f4; color: #666; font-style: italic; }
        
        .auto-detected {
            background: #e6f4ea;
            border: 1px solid #34a853;
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 13px;
        }
        .auto-detected .icon { color: #34a853; margin-right: 5px; }
        
        .detected-summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .detected-item {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìö Course Collision Checker</h1>
        <p class="subtitle">Check if returning students have already taken their scheduled courses</p>
    </div>

    <!-- STEP 1: Upload PDF -->
    <div class="step active" id="step1">
        <div class="step-header">
            <div class="step-number"><span>1</span></div>
            <div class="step-title">Upload Timetable PDF</div>
        </div>
        <div class="step-content">
            <div class="upload-zone" id="uploadZone">
                <input type="file" id="pdfInput" accept=".pdf">
                <div class="icon">üìÑ</div>
                <p><strong>Drop PDF here</strong> or click to browse</p>
            </div>
            <div id="step1Status" class="status"></div>
            <div id="courseStats" class="stats"></div>
            
            <div id="sendCoursesSection" style="display: none; margin-top: 15px;">
                <button class="btn btn-success btn-large" onclick="sendCourses()" id="sendCoursesBtn">
                    üì§ Send Courses to Google Sheet
                </button>
            </div>
            
            <details id="courseDetails" style="display: none;">
                <summary>üìë View extracted courses</summary>
                <div class="table-container" id="courseTable"></div>
            </details>
            
            <details class="help-section" style="margin-top: 15px;">
                <summary>‚ùì PDF not working?</summary>
                <div class="help-content">
                    <h4>What this tool extracts:</h4>
                    <ul>
                        <li><strong>Course codes</strong> like <code>1022B</code>, <code>2040A</code> (4 digits + letter)</li>
                        <li><strong>Level</strong> from the page header (Certificate, Diploma, MBA, etc.)</li>
                    </ul>
                    <p>Course names come from the raw grade data, not the PDF.</p>
                </div>
            </details>
        </div>
    </div>

    <!-- STEP 2: Import Students -->
    <div class="step" id="step2">
        <div class="step-header">
            <div class="step-number"><span>2</span></div>
            <div class="step-title">Import Class List</div>
        </div>
        <div class="step-content">
            <p>Paste the Google Sheet URL containing your class list:</p>
            <div class="input-group">
                <input type="text" id="studentsUrl" placeholder="https://docs.google.com/spreadsheets/d/xxxxx/edit#gid=0">
                <button class="btn btn-primary" onclick="importStudents()" id="importStudentsBtn">üì• Import</button>
            </div>
            <div id="step2Status" class="status"></div>
            
            <details class="help-section">
                <summary>‚ùì Help & Troubleshooting</summary>
                <div class="help-content">
                    <h4>Required columns:</h4>
                    <ul>
                        <li><strong>Session</strong> ‚Äî current term (e.g., <code>26-T1</code>)</li>
                        <li><strong>Class</strong> ‚Äî when they started (e.g., <code>25-T4-Class-Certificate</code>)</li>
                        <li><strong>School Email</strong> ‚Äî student email addresses</li>
                    </ul>
                    
                    <h4>Term detection:</h4>
                    <p>The system compares Session vs Class to determine if a student is in Term 1 or Term 2 of their level.</p>
                </div>
            </details>
        </div>
    </div>

    <!-- STEP 3: Update Raw Data -->
    <div class="step" id="step3">
        <div class="step-header">
            <div class="step-number"><span>3</span></div>
            <div class="step-title">Update Historical Grade Data</div>
        </div>
        <div class="step-content">
            <p>Import the latest grade records from the nightly backup:</p>
            <button class="btn btn-primary" onclick="updateRaw()" id="updateRawBtn">üîÑ Update Raw Data</button>
            <button class="btn" style="background: #f1f3f4; color: #333;" onclick="skipStep3()" id="skipStep3Btn">Skip (use existing) ‚Üí</button>
            <div id="step3Status" class="status"></div>
            
            <div class="info-box">
                <strong>‚ö†Ô∏è Required on first use</strong> or if grades have changed.<br>
                <span style="color: #666;">Skip only if you've already updated raw data recently.</span>
            </div>
        </div>
    </div>

    <!-- STEP 4: Check Collisions -->
    <div class="step" id="step4">
        <div class="step-header">
            <div class="step-number"><span>4</span></div>
            <div class="step-title">Check for Collisions</div>
        </div>
        <div class="step-content">
            <p>Run the collision check to find students who have already taken their scheduled courses:</p>
            <button class="btn btn-success btn-large" onclick="checkCollisions()" id="checkBtn">üîç Check for Collisions</button>
            <div id="step4Status" class="status"></div>
            
            <details class="help-section" style="margin-top: 15px;">
                <summary>‚ùì How collision detection works</summary>
                <div class="help-content">
                    <h4>Color coding in results:</h4>
                    <table class="help-table">
                        <tr>
                            <td style="background: #fef7e0;">‚ö†Ô∏è Orange</td>
                            <td>Total grade <60% - insufficient, may need academic review</td>
                        </tr>
                        <tr>
                            <td style="background: #fce8e6;">‚úì Red</td>
                            <td>Total grade ‚â•60% - passed, cannot retake course</td>
                        </tr>
                    </table>
                </div>
            </details>
        </div>
    </div>

    <!-- Results -->
    <div id="resultsSection" style="display: none;"></div>

    <!-- Hidden toggle for Progression Predictor -->
    <div style="text-align: center; margin: 20px 0;">
        <button class="btn btn-secondary" onclick="toggleProgressionPredictor()" id="predictorToggle" style="opacity: 0.6;">
            üîÆ Predict Next Term Class List
        </button>
    </div>

    <!-- PROGRESSION PREDICTOR (Hidden by default) -->
    <div class="step progression-section hidden-feature" id="progressionSection">
        <div class="step-header">
            <div class="step-number"><span>üîÆ</span></div>
            <div class="step-title">Student Progression Predictor</div>
        </div>
        <div class="step-content">
            <p>Predict which students will be on the class list for the next term based on the current class list.</p>
            
            <!-- Progression Rules Reference -->
            <details class="help-section">
                <summary>üìã Progression Rules</summary>
                <div class="help-content">
                    <h4>Business Track:</h4>
                    <div class="progression-visual">
                        <div class="prog-step level-English">English<br><small>1 term</small></div>
                        <div class="prog-arrow">‚Üí</div>
                        <div class="prog-step level-Certificate">Certificate<br><small>2 terms</small></div>
                        <div class="prog-arrow">‚Üí üì¶ ‚Üí</div>
                        <div class="prog-step level-Diploma">Diploma<br><small>2 terms</small></div>
                        <div class="prog-arrow">‚Üí üì¶ ‚Üí</div>
                        <div class="prog-step level-High-Diploma">High Diploma<br><small>2 terms</small></div>
                        <div class="prog-arrow">‚Üí üì¶ ‚Üí</div>
                        <div class="prog-step level-BBA">BBA<br><small>2 terms</small></div>
                        <div class="prog-degree">üéì</div>
                        <div class="prog-arrow">‚Üí üì¶ ‚Üí</div>
                        <div class="prog-step level-PGD">PGD<br><small>2 terms</small></div>
                        <div class="prog-arrow">‚Üí üì¶ ‚Üí</div>
                        <div class="prog-step level-MBA">MBA<br><small>2 terms</small></div>
                        <div class="prog-degree">üéì</div>
                    </div>
                    
                    <h4>Culinary Track:</h4>
                    <div class="progression-visual">
                        <div class="prog-step level-CUL-I">CUL I<br><small>2 terms</small></div>
                        <div class="prog-arrow">‚Üí üì¶ ‚Üí</div>
                        <div class="prog-step level-CUL-II">CUL II<br><small>2 terms</small></div>
                        <div class="prog-arrow">‚Üí üì¶ ‚Üí</div>
                        <div class="prog-step level-CUL-III">CUL III<br><small>2 terms</small></div>
                    </div>
                    
                    <p style="font-size: 11px; color: #666; margin-top: 10px;">
                        üì¶ = 2 terms internship (not on class list) | üéì = Degree awarded (BBA and MBA)
                    </p>
                    
                    <h4>Key Rules:</h4>
                    <ul>
                        <li><strong>English</strong> is 1 term only, then directly to Certificate (no internship)</li>
                        <li><strong>BBA graduates</strong> can CHOOSE to continue or stop (have a degree)</li>
                        <li><strong>MBA graduates</strong> are finished (final degree)</li>
                        <li><strong>Failed grades</strong> may require repeating courses</li>
                    </ul>
                </div>
            </details>

            <!-- Load class list for prediction -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 8px;">
                <h4 style="margin-top: 0;">üì• Load Current Class List</h4>
                <p style="font-size: 12px; color: #666;">Load a class list with Session and Class columns to auto-detect term status.</p>
                <div class="input-group">
                    <input type="text" id="predictionUrl" placeholder="Paste Google Sheet URL with current class list">
                    <button class="btn btn-purple" onclick="loadForPrediction()" id="loadPredBtn">Load</button>
                </div>
                <div id="predLoadStatus" class="status"></div>
                
                <!-- Auto-detected info -->
                <div id="autoDetectedSection" style="display: none;">
                    <div class="auto-detected">
                        <span class="icon">‚úì</span>
                        <strong>Auto-detected from Session vs Class columns:</strong>
                        <div class="detected-summary" id="detectedSummary"></div>
                    </div>
                    
                    <div class="term-selector">
                        <label>Current Session:</label>
                        <strong id="detectedSession">--</strong>
                        <span style="margin-left: 15px;">‚Üí Predicting for: <strong id="nextTermDisplay">--</strong></span>
                    </div>
                </div>
                
                <!-- Optional: Load failed grades -->
                <div id="failedGradesSection" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                    <h4 style="margin: 0 0 10px 0;">üìä Load Failed Grades (Optional)</h4>
                    <p style="font-size: 12px; color: #666;">Upload a list of students with failed grades to flag them in the prediction.</p>
                    <div class="input-group">
                        <input type="text" id="failedGradesUrl" placeholder="Google Sheet URL with failed grades (email column required)">
                        <button class="btn btn-secondary" onclick="loadFailedGrades()" id="loadFailedBtn">Load</button>
                    </div>
                    <div id="failedLoadStatus" class="status"></div>
                </div>
            </div>
            
            <!-- Generate Prediction Button -->
            <div id="generatePredictionSection" style="display: none;">
                <button class="btn btn-purple btn-large" onclick="generatePrediction()" id="generatePredBtn">
                    üîÆ Generate Next Term Prediction
                </button>
            </div>

            <!-- Prediction Results -->
            <div id="predictionResults" style="display: none;"></div>
        </div>
    </div>

    <div class="footer">
        Swiss Educational College ‚Ä¢ Course Collision Checker<br>
        <small>Supported: English, Certificate, Diploma, High Diploma, BBA, PGD, MBA, CUL I, CUL II, CUL III</small>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzD-Fsbe8g4eXlwIE-VYpOFIxCftbchaxyYXafgWRfn7nzLz3n7feLo6G8zXqx14eb2/exec';
        
        let extractedCourses = [];
        let pdfFileName = '';

        // ========== PROGRESSION PREDICTOR STATE ==========
        
        // Business track progression
        const BUSINESS_TRACK = ['English', 'Certificate', 'Diploma', 'High Diploma', 'BBA', 'PGD', 'MBA'];
        // Culinary track progression  
        const CULINARY_TRACK = ['CUL I', 'CUL II', 'CUL III', 'CUL'];
        
        const LEVEL_TERMS = {
            'English': 1,       // 1 term only, no internship after
            'Certificate': 2,
            'Diploma': 2,
            'High Diploma': 2,
            'BBA': 2,           // Degree - optional to continue
            'PGD': 2,
            'MBA': 2,           // Final degree
            'CUL I': 2,
            'CUL II': 2,
            'CUL III': 2,
            'CUL': 2
        };
        
        const DEGREE_LEVELS = ['BBA', 'MBA'];
        const FINAL_LEVELS = ['MBA', 'CUL III']; // Cannot continue after these
        const OPTIONAL_CONTINUE = ['BBA']; // Have degree, can choose to stop
        
        let loadedStudents = [];
        let failedStudents = new Set(); // emails of students with failed grades
        let detectedSession = null;

        function toggleProgressionPredictor() {
            const section = document.getElementById('progressionSection');
            const btn = document.getElementById('predictorToggle');
            
            if (section.classList.contains('visible')) {
                section.classList.remove('visible');
                btn.textContent = 'üîÆ Predict Next Term Class List';
                btn.style.opacity = '0.6';
            } else {
                section.classList.add('visible');
                btn.textContent = 'üîÆ Hide Prediction Tool';
                btn.style.opacity = '1';
                section.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function parseSession(sessionStr) {
            // Parse "25-T4" format
            const match = sessionStr.match(/(\d{2})-T(\d)/);
            if (match) {
                return { year: parseInt(match[1]), term: parseInt(match[2]) };
            }
            return null;
        }

        function parseClassString(classStr) {
            // Parse "25-T3-Class-Certificate" or "25-T3-Class-High Diploma" or "25-T3-Class-CUL I"
            const match = classStr.match(/(\d{2})-T(\d)-Class-(.+)/i);
            if (match) {
                return {
                    year: parseInt(match[1]),
                    term: parseInt(match[2]),
                    level: match[3].trim()
                };
            }
            return null;
        }

        function getNextTerm(year, term) {
            let nextYear = year;
            let nextTerm = term + 1;
            if (nextTerm > 4) {
                nextTerm = 1;
                nextYear = year + 1;
            }
            return { year: nextYear, term: nextTerm };
        }

        function formatTerm(year, term) {
            return `${year}-T${term}`;
        }

        function getNextLevel(currentLevel) {
            // Check which track
            let track = BUSINESS_TRACK;
            if (CULINARY_TRACK.some(l => currentLevel.toUpperCase().includes(l.toUpperCase().replace(' ', '')))) {
                track = CULINARY_TRACK;
            }
            
            const idx = track.findIndex(l => l.toUpperCase() === currentLevel.toUpperCase());
            if (idx === -1 || idx === track.length - 1) return null;
            return track[idx + 1];
        }

        function detectTermNumber(session, classInfo) {
            // Compare session term with class start term
            // If session = 25-T4 and class = 25-T3-Class-X, student started in T3, now in T4 = Term 2
            // If session = 25-T4 and class = 25-T4-Class-X, student started this term = Term 1
            
            if (!session || !classInfo) return 1;
            
            const sessionTotal = session.year * 4 + session.term;
            const classTotal = classInfo.year * 4 + classInfo.term;
            
            return sessionTotal - classTotal + 1; // Term 1 or Term 2
        }

        function getTrack(level) {
            if (CULINARY_TRACK.some(l => level.toUpperCase().includes(l.toUpperCase().replace(' ', '')))) {
                return 'culinary';
            }
            return 'business';
        }

        async function loadForPrediction() {
            const url = document.getElementById('predictionUrl').value.trim();
            
            if (!url) {
                document.getElementById('predLoadStatus').className = 'status error';
                document.getElementById('predLoadStatus').textContent = '‚ö†Ô∏è Please paste a Google Sheet URL';
                return;
            }
            
            const btn = document.getElementById('loadPredBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥...';
            
            document.getElementById('predLoadStatus').className = 'status info';
            document.getElementById('predLoadStatus').textContent = '‚è≥ Loading students...';
            
            try {
                const idMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
                if (!idMatch) throw new Error('Invalid Google Sheets URL');
                
                const sheetId = idMatch[1];
                const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
                
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error('Could not access the spreadsheet. Make sure it is shared publicly.');
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                if (rows.length < 2) throw new Error('Spreadsheet appears to be empty');
                
                // Find columns
                const headers = rows[0].map(h => h.toLowerCase().trim());
                const sessionIdx = headers.findIndex(h => h === 'session');
                const classIdx = headers.findIndex(h => h === 'class' || h.includes('class'));
                const emailIdx = headers.findIndex(h => h.includes('email') && !h.includes('recovery') && !h.includes('personal'));
                const nameIdx = headers.findIndex(h => h.includes('first name') || h.includes('firstname'));
                const lastNameIdx = headers.findIndex(h => h.includes('last name') || h.includes('lastname'));
                const callNameIdx = headers.findIndex(h => h.includes('call name') || h.includes('callname'));
                const statusIdx = headers.findIndex(h => h.includes('new/return') || h === 'status');
                
                if (classIdx === -1 || emailIdx === -1) {
                    throw new Error('Could not find Class and Email columns');
                }
                
                // Parse students
                loadedStudents = [];
                const levelStats = {};
                let mostCommonSession = null;
                const sessionCounts = {};
                
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row[emailIdx]) continue;
                    
                    const sessionStr = sessionIdx >= 0 ? row[sessionIdx] : '';
                    const classStr = row[classIdx] || '';
                    const session = parseSession(sessionStr);
                    const classInfo = parseClassString(classStr);
                    
                    if (!classInfo || !classInfo.level) continue;
                    
                    // Track session frequency
                    if (sessionStr) {
                        sessionCounts[sessionStr] = (sessionCounts[sessionStr] || 0) + 1;
                    }
                    
                    // Determine term number (1 or 2)
                    const termNumber = detectTermNumber(session, classInfo);
                    
                    // Get display name
                    let displayName = '';
                    if (callNameIdx >= 0 && row[callNameIdx]) {
                        displayName = row[callNameIdx];
                    } else if (nameIdx >= 0) {
                        displayName = row[nameIdx] + (lastNameIdx >= 0 ? ' ' + row[lastNameIdx] : '');
                    }
                    
                    const student = {
                        email: row[emailIdx].trim(),
                        name: displayName.trim(),
                        classStr: classStr,
                        level: classInfo.level,
                        classYear: classInfo.year,
                        classTerm: classInfo.term,
                        sessionYear: session ? session.year : null,
                        sessionTerm: session ? session.term : null,
                        termNumber: termNumber,
                        status: statusIdx >= 0 ? row[statusIdx] : '',
                        track: getTrack(classInfo.level)
                    };
                    
                    loadedStudents.push(student);
                    
                    const key = `${classInfo.level} (Term ${termNumber})`;
                    levelStats[key] = (levelStats[key] || 0) + 1;
                }
                
                if (loadedStudents.length === 0) {
                    throw new Error('No valid students found');
                }
                
                // Find most common session
                mostCommonSession = Object.entries(sessionCounts).sort((a, b) => b[1] - a[1])[0]?.[0];
                detectedSession = parseSession(mostCommonSession);
                
                // Display detected info
                const summaryHtml = Object.entries(levelStats)
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .map(([key, count]) => {
                        const levelMatch = key.match(/(.+) \(Term (\d)\)/);
                        const level = levelMatch ? levelMatch[1] : key;
                        const term = levelMatch ? levelMatch[2] : '?';
                        const levelClass = 'level-' + level.replace(/\s+/g, '-');
                        return `<div class="detected-item">
                            <span><span class="level-badge ${levelClass}">${level}</span> Term ${term}</span>
                            <strong>${count}</strong>
                        </div>`;
                    })
                    .join('');
                
                document.getElementById('detectedSummary').innerHTML = summaryHtml;
                document.getElementById('detectedSession').textContent = mostCommonSession || 'Unknown';
                
                if (detectedSession) {
                    const next = getNextTerm(detectedSession.year, detectedSession.term);
                    document.getElementById('nextTermDisplay').textContent = formatTerm(next.year, next.term);
                }
                
                document.getElementById('autoDetectedSection').style.display = 'block';
                document.getElementById('failedGradesSection').style.display = 'block';
                document.getElementById('generatePredictionSection').style.display = 'block';
                
                document.getElementById('predLoadStatus').className = 'status success';
                document.getElementById('predLoadStatus').textContent = `‚úÖ Loaded ${loadedStudents.length} students with auto-detected term status`;
                
            } catch (error) {
                document.getElementById('predLoadStatus').className = 'status error';
                document.getElementById('predLoadStatus').textContent = '‚ùå ' + error.message;
            }
            
            btn.disabled = false;
            btn.textContent = 'Load';
        }

        async function loadFailedGrades() {
            const url = document.getElementById('failedGradesUrl').value.trim();
            
            if (!url) {
                document.getElementById('failedLoadStatus').className = 'status error';
                document.getElementById('failedLoadStatus').textContent = '‚ö†Ô∏è Please paste a Google Sheet URL';
                return;
            }
            
            const btn = document.getElementById('loadFailedBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥...';
            
            try {
                const idMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
                if (!idMatch) throw new Error('Invalid URL');
                
                const sheetId = idMatch[1];
                const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
                
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error('Could not access spreadsheet');
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                const headers = rows[0].map(h => h.toLowerCase().trim());
                const emailIdx = headers.findIndex(h => h.includes('email'));
                
                if (emailIdx === -1) throw new Error('No email column found');
                
                failedStudents = new Set();
                for (let i = 1; i < rows.length; i++) {
                    if (rows[i][emailIdx]) {
                        failedStudents.add(rows[i][emailIdx].trim().toLowerCase());
                    }
                }
                
                document.getElementById('failedLoadStatus').className = 'status success';
                document.getElementById('failedLoadStatus').textContent = `‚úÖ Loaded ${failedStudents.size} students with failed grades`;
                
            } catch (error) {
                document.getElementById('failedLoadStatus').className = 'status error';
                document.getElementById('failedLoadStatus').textContent = '‚ùå ' + error.message;
            }
            
            btn.disabled = false;
            btn.textContent = 'Load';
        }

        function parseCSV(text) {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let inQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];
                
                if (inQuotes) {
                    if (char === '"' && nextChar === '"') {
                        currentCell += '"';
                        i++;
                    } else if (char === '"') {
                        inQuotes = false;
                    } else {
                        currentCell += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === ',') {
                        currentRow.push(currentCell);
                        currentCell = '';
                    } else if (char === '\n' || (char === '\r' && nextChar === '\n')) {
                        currentRow.push(currentCell);
                        rows.push(currentRow);
                        currentRow = [];
                        currentCell = '';
                        if (char === '\r') i++;
                    } else if (char !== '\r') {
                        currentCell += char;
                    }
                }
            }
            
            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell);
                rows.push(currentRow);
            }
            
            return rows;
        }

        function generatePrediction() {
            if (loadedStudents.length === 0) {
                alert('Please load a class list first');
                return;
            }
            
            if (!detectedSession) {
                alert('Could not detect current session. Please check the data.');
                return;
            }
            
            const next = getNextTerm(detectedSession.year, detectedSession.term);
            const nextTermStr = formatTerm(next.year, next.term);
            
            const continuing = [];      // Term 1 students continuing to Term 2
            const toInternship = [];    // Term 2 students going to internship
            const graduating = [];      // MBA Term 2 / CUL III Term 2 = finished
            const optionalReturn = [];  // BBA Term 2 = have degree, optional to continue
            const withFailedGrades = []; // Students with failed grades (need attention)
            
            for (const student of loadedStudents) {
                const hasFailed = failedStudents.has(student.email.toLowerCase());
                const levelTerms = LEVEL_TERMS[student.level] || 2;
                
                // Check if student has failed grades
                if (hasFailed) {
                    withFailedGrades.push({
                        ...student,
                        note: 'Has failed grades - may need to repeat'
                    });
                }
                
                // English special case: 1 term only, then Certificate
                if (student.level === 'English') {
                    continuing.push({
                        ...student,
                        nextLevel: 'Certificate',
                        nextClass: `${next.year}-T${next.term}-Class-Certificate`,
                        reason: 'Completed English ‚Üí Certificate'
                    });
                    continue;
                }
                
                // Check if final level (MBA or CUL III)
                const isFinal = FINAL_LEVELS.includes(student.level);
                const isOptional = OPTIONAL_CONTINUE.includes(student.level);
                
                if (student.termNumber === 1) {
                    // Term 1 ‚Üí Continue to Term 2 (same level)
                    continuing.push({
                        ...student,
                        nextLevel: student.level,
                        nextClass: `${next.year}-T${next.term}-Class-${student.level}`,
                        reason: 'Continuing to Term 2'
                    });
                } else {
                    // Term 2 ‚Üí Finishing this level
                    if (isFinal) {
                        // MBA or CUL III = Finished/Graduated
                        graduating.push({
                            ...student,
                            reason: `Completed ${student.level} üéì`
                        });
                    } else if (isOptional) {
                        // BBA = Optional to continue
                        optionalReturn.push({
                            ...student,
                            nextLevel: getNextLevel(student.level),
                            reason: 'Completed BBA (Degree) - May choose to continue to PGD or stop'
                        });
                    } else {
                        // Going to internship
                        const nextLevel = getNextLevel(student.level);
                        toInternship.push({
                            ...student,
                            nextLevel: nextLevel,
                            reason: nextLevel ? `‚Üí Internship ‚Üí ${nextLevel}` : '‚Üí Internship'
                        });
                    }
                }
            }
            
            // Build results HTML
            let html = `
                <div class="prediction-results">
                    <h3 style="margin-top: 0;">üìä Predicted Class List for ${nextTermStr}</h3>
            `;
            
            // Continuing students (will be on next class list)
            if (continuing.length > 0) {
                html += `
                    <div class="prediction-group continuing">
                        <h4>üìö On Next Class List <span class="count">${continuing.length}</span></h4>
                        <div class="student-list">
                            ${continuing.map(s => `
                                <div class="student-item">
                                    <span class="name">${s.name || s.email.split('@')[0]}</span>
                                    <span class="email">${s.email}</span>
                                    <span class="level-badge level-${s.nextLevel.replace(/\s+/g, '-')}">${s.nextLevel}</span>
                                    <span class="status-tag ${s.termNumber === 1 ? 'term1' : 'term2'}">${s.reason}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // BBA graduates (optional return)
            if (optionalReturn.length > 0) {
                html += `
                    <div class="prediction-group optional">
                        <h4>üéì BBA Graduates - Optional Return <span class="count">${optionalReturn.length}</span></h4>
                        <p style="font-size: 12px; color: #666; margin: 0 0 10px 0;">
                            These students have earned their BBA degree and may choose to continue to PGD or stop here.
                        </p>
                        <div class="student-list">
                            ${optionalReturn.map(s => `
                                <div class="student-item">
                                    <span class="name">${s.name || s.email.split('@')[0]}</span>
                                    <span class="email">${s.email}</span>
                                    <span class="level-badge level-BBA">BBA üéì</span>
                                    <span style="color: #666; font-size: 11px;">‚Üí PGD or Stop</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Going to internship
            if (toInternship.length > 0) {
                html += `
                    <div class="prediction-group internship">
                        <h4>‚úàÔ∏è Going to Internship <span class="count">${toInternship.length}</span></h4>
                        <p style="font-size: 12px; color: #666; margin: 0 0 10px 0;">
                            These students finished their current level and will be on internship for 2 terms.
                        </p>
                        <div class="student-list">
                            ${toInternship.map(s => `
                                <div class="student-item">
                                    <span class="name">${s.name || s.email.split('@')[0]}</span>
                                    <span class="email">${s.email}</span>
                                    <span class="level-badge level-${s.level.replace(/\s+/g, '-')}">${s.level}</span>
                                    <span style="color: #666; font-size: 11px;">${s.reason}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Graduating (MBA / CUL III)
            if (graduating.length > 0) {
                html += `
                    <div class="prediction-group graduating">
                        <h4>üéì Graduating / Finished <span class="count">${graduating.length}</span></h4>
                        <div class="student-list">
                            ${graduating.map(s => `
                                <div class="student-item">
                                    <span class="name">${s.name || s.email.split('@')[0]}</span>
                                    <span class="email">${s.email}</span>
                                    <span class="level-badge level-${s.level.replace(/\s+/g, '-')}">${s.level} üéì</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Students with failed grades
            if (withFailedGrades.length > 0) {
                html += `
                    <div class="prediction-group failed">
                        <h4>‚ö†Ô∏è Students with Failed Grades <span class="count">${withFailedGrades.length}</span></h4>
                        <p style="font-size: 12px; color: #666; margin: 0 0 10px 0;">
                            These students have failed grades and may need academic review before progressing.
                        </p>
                        <div class="student-list">
                            ${withFailedGrades.map(s => `
                                <div class="student-item">
                                    <span class="name">${s.name || s.email.split('@')[0]}</span>
                                    <span class="email">${s.email}</span>
                                    <span class="level-badge level-${s.level.replace(/\s+/g, '-')}">${s.level}</span>
                                    <span class="status-tag failed">Failed grades</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Summary and export
            html += `
                <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #eee;">
                    <h4 style="margin-top: 0;">üìã Summary</h4>
                    <div class="stats">
                        <div class="stat"><strong>üìö On Next Class List:</strong> ${continuing.length}</div>
                        <div class="stat"><strong>üéì BBA (Optional):</strong> ${optionalReturn.length}</div>
                        <div class="stat"><strong>‚úàÔ∏è To Internship:</strong> ${toInternship.length}</div>
                        <div class="stat"><strong>üéì Graduating:</strong> ${graduating.length}</div>
                        ${withFailedGrades.length > 0 ? `<div class="stat" style="background: #fce8e6;"><strong>‚ö†Ô∏è Failed Grades:</strong> ${withFailedGrades.length}</div>` : ''}
                    </div>
                    
                    <button class="export-btn" onclick="exportPrediction('classlist')">
                        üì• Export Class List (CSV)
                    </button>
                    <button class="export-btn" onclick="exportPrediction('all')" style="background: #666;">
                        üì• Export All Groups (CSV)
                    </button>
                </div>
            </div>
            `;
            
            // Store for export
            window.predictionData = {
                term: nextTermStr,
                continuing,
                optionalReturn,
                toInternship,
                graduating,
                withFailedGrades
            };
            
            document.getElementById('predictionResults').innerHTML = html;
            document.getElementById('predictionResults').style.display = 'block';
            document.getElementById('predictionResults').scrollIntoView({ behavior: 'smooth' });
        }

        function exportPrediction(type) {
            if (!window.predictionData) {
                alert('Please generate a prediction first');
                return;
            }
            
            const data = window.predictionData;
            let csv = 'Email,Name,Current Level,Next Level,Next Class,Status,Group\n';
            
            if (type === 'classlist' || type === 'all') {
                for (const s of data.continuing) {
                    csv += `"${s.email}","${s.name || ''}","${s.level}","${s.nextLevel}","${s.nextClass}","${s.reason}","On Class List"\n`;
                }
            }
            
            if (type === 'all') {
                for (const s of data.optionalReturn) {
                    csv += `"${s.email}","${s.name || ''}","${s.level}","${s.nextLevel || 'Optional'}","","${s.reason}","BBA Graduate (Optional)"\n`;
                }
                for (const s of data.toInternship) {
                    csv += `"${s.email}","${s.name || ''}","${s.level}","${s.nextLevel || ''}","Internship","${s.reason}","To Internship"\n`;
                }
                for (const s of data.graduating) {
                    csv += `"${s.email}","${s.name || ''}","${s.level}","","Finished","${s.reason}","Graduating"\n`;
                }
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = type === 'classlist' 
                ? `predicted_class_list_${data.term}.csv`
                : `prediction_all_groups_${data.term}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ========== ORIGINAL COLLISION CHECKER CODE ==========
        
        let validCourseCodes = new Set();
        const COURSE_CODE_PATTERN = /\(?(C?)(\d{4})\s*\(?([A-Z])\)?\)?/g;

        async function fetchValidCourseCodes() {
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getCourseCodes`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.codes && Array.isArray(data.codes)) {
                        validCourseCodes = new Set(data.codes.map(c => c.toUpperCase()));
                        console.log('Loaded', validCourseCodes.size, 'valid course codes');
                        const step1 = document.getElementById('step1Status');
                        if (step1 && !step1.innerHTML) {
                            step1.innerHTML = `<small style="color:#666;">‚úì ${validCourseCodes.size} valid course codes loaded</small>`;
                        }
                    }
                }
            } catch (e) {
                console.log('Could not fetch valid course codes:', e);
            }
        }

        function isValidCourseCode(code) {
            if (validCourseCodes.size === 0) return true;
            if (validCourseCodes.has(code)) return true;
            if (code.startsWith('C')) {
                const baseCode = code.substring(1);
                if (validCourseCodes.has(baseCode)) return true;
            }
            return false;
        }

        function detectLevel(pageText) {
            const header = pageText.substring(0, 200).toUpperCase();
            if (header.includes('CUL III')) return 'CUL III';
            if (header.includes('CUL II')) return 'CUL II';
            if (header.includes('CUL I') && !header.includes('CUL II')) return 'CUL I';
            if (header.includes('CUL') && !header.includes('CUL I')) return 'CUL';
            if (header.includes('HIGH DIPLOMA')) return 'High Diploma';
            if (header.includes('DIPLOMA') && !header.includes('HIGH')) return 'Diploma';
            if (header.includes('CERTIFICATE')) return 'Certificate';
            if (header.includes('MBA')) return 'MBA';
            if (header.includes('BBA')) return 'BBA';
            if (header.includes('PGD')) return 'PGD';
            if (header.includes('ENGLISH')) return 'English';
            return 'Unknown';
        }

        async function parsePDF(file) {
            setStatus('step1Status', 'info', '‚è≥ Processing PDF...');
            pdfFileName = file.name;
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                const allCourses = new Map();
                const levelStats = {};

                for (let i = 1; i <= pdf.numPages; i++) {
                    setStatus('step1Status', 'info', `‚è≥ Processing page ${i} of ${pdf.numPages}...`);
                    
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    
                    const level = detectLevel(pageText);
                    
                    let match;
                    const courseCodesFound = new Set();
                    COURSE_CODE_PATTERN.lastIndex = 0;
                    
                    while ((match = COURSE_CODE_PATTERN.exec(pageText)) !== null) {
                        const prefix = match[1] || '';
                        const digits = match[2];
                        const letter = match[3].toUpperCase();
                        const matchStart = match.index;
                        const contextBefore = pageText.substring(Math.max(0, matchStart - 5), matchStart);
                        
                        if (/[\d][.\/]$/.test(contextBefore)) continue;
                        
                        const code = prefix + digits + letter;
                        if (isValidCourseCode(code)) courseCodesFound.add(code);
                    }
                    
                    for (const code of courseCodesFound) {
                        if (!allCourses.has(code)) {
                            allCourses.set(code, { name: '', levels: new Set() });
                        }
                        if (level !== 'Unknown') {
                            allCourses.get(code).levels.add(level);
                        }
                    }
                }

                extractedCourses = [];
                allCourses.forEach((data, code) => {
                    const levels = data.levels.size > 0 ? [...data.levels] : ['Unknown'];
                    for (const level of levels) {
                        extractedCourses.push({ code, name: data.name || '', level });
                        levelStats[level] = (levelStats[level] || 0) + 1;
                    }
                });
                extractedCourses.sort((a, b) => a.level.localeCompare(b.level) || a.code.localeCompare(b.code));

                document.getElementById('courseStats').innerHTML = Object.entries(levelStats)
                    .map(([level, count]) => `<div class="stat"><strong>${level}:</strong> ${count}</div>`).join('');
                
                let html = '<table><thead><tr><th>Code</th><th>Level</th></tr></thead><tbody>';
                for (const c of extractedCourses) {
                    const levelClass = 'level-' + c.level.replace(/\s+/g, '-');
                    html += `<tr><td><strong>${c.code}</strong></td><td><span class="level-badge ${levelClass}">${c.level}</span></td></tr>`;
                }
                html += '</tbody></table>';
                document.getElementById('courseTable').innerHTML = html;
                
                document.getElementById('sendCoursesSection').style.display = 'block';
                document.getElementById('courseDetails').style.display = 'block';
                
                setStatus('step1Status', 'success', `‚úÖ Extracted ${extractedCourses.length} courses from ${pdf.numPages} pages`);
                
            } catch (error) {
                setStatus('step1Status', 'error', `‚ùå Error: ${error.message}`);
            }
        }

        async function sendCourses() {
            if (!extractedCourses || extractedCourses.length === 0) {
                setStatus('step1Status', 'error', '‚ö†Ô∏è No courses extracted');
                return;
            }
            
            const btn = document.getElementById('sendCoursesBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Sending...';
            
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'importCourses', courses: extractedCourses, pdfName: pdfFileName })
                });
                
                setStatus('step1Status', 'success', `‚úÖ ${extractedCourses.length} courses sent!`);
                completeStep('step1');
                activateStep('step2');
                btn.textContent = '‚úÖ Sent!';
            } catch (error) {
                setStatus('step1Status', 'error', '‚ùå Error sending courses');
                btn.textContent = 'üì§ Send Courses';
                btn.disabled = false;
            }
        }
        
        async function importStudents() {
            const url = document.getElementById('studentsUrl').value.trim();
            if (!url) {
                setStatus('step2Status', 'error', '‚ö†Ô∏è Please paste a Google Sheet URL');
                return;
            }
            
            const btn = document.getElementById('importStudentsBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥...';
            setStatus('step2Status', 'info', '‚è≥ Importing students...');
            
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'importStudents', url })
                });
                
                await new Promise(r => setTimeout(r, 3000));
                setStatus('step2Status', 'success', '‚úÖ Import request sent!');
                completeStep('step2');
                activateStep('step3');
            } catch (error) {
                setStatus('step2Status', 'error', '‚ùå Network error');
            }
            
            btn.disabled = false;
            btn.textContent = 'üì• Import';
        }
        
        async function updateRaw() {
            const btn = document.getElementById('updateRawBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Updating...';
            setStatus('step3Status', 'info', '‚è≥ Fetching latest backup...');
            
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'updateRaw' })
                });
                
                await new Promise(r => setTimeout(r, 5000));
                setStatus('step3Status', 'success', '‚úÖ Raw data updated!');
                completeStep('step3');
                activateStep('step4');
            } catch (error) {
                setStatus('step3Status', 'error', '‚ùå Error updating');
            }
            
            btn.disabled = false;
            btn.textContent = 'üîÑ Update Raw Data';
        }
        
        async function checkCollisions() {
            const btn = document.getElementById('checkBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Checking...';
            setStatus('step4Status', 'info', '‚è≥ Running collision check...');
            
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'checkCollisions' })
                });
                
                await new Promise(r => setTimeout(r, 5000));
                setStatus('step4Status', 'success', '‚úÖ Collision check complete!');
                completeStep('step4');
                
                document.getElementById('resultsSection').innerHTML = `
                    <div class="results-box">
                        <h2>üéâ Check Complete!</h2>
                        <p>View the results in Google Sheets:</p>
                        <a href="https://docs.google.com/spreadsheets/d/1omcWpajVrVMTWiOdKL5YQr40KxlRHCogJpfKuRUsdWY/edit?gid=808012596#gid=808012596" target="_blank">
                            üìä Open Results Tab
                        </a>
                    </div>
                `;
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                setStatus('step4Status', 'error', '‚ùå Error');
            }
            
            btn.disabled = false;
            btn.textContent = 'üîç Run Again';
        }

        function setStatus(id, type, message) {
            const el = document.getElementById(id);
            el.className = 'status ' + type;
            el.textContent = message;
        }
        
        function completeStep(stepId) {
            document.getElementById(stepId).classList.remove('active');
            document.getElementById(stepId).classList.add('complete');
        }
        
        function activateStep(stepId) {
            document.getElementById(stepId).classList.add('active');
        }
        
        function skipStep3() {
            setStatus('step3Status', 'warning', '‚è≠Ô∏è Skipped ‚Äî using existing raw data');
            document.getElementById('step3').classList.remove('active');
            activateStep('step4');
        }

        // File upload handlers
        const uploadZone = document.getElementById('uploadZone');
        const pdfInput = document.getElementById('pdfInput');

        uploadZone.addEventListener('click', () => pdfInput.click());
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files[0]?.type === 'application/pdf') parsePDF(e.dataTransfer.files[0]);
        });
        pdfInput.addEventListener('change', (e) => { if (e.target.files[0]) parsePDF(e.target.files[0]); });
        
        fetchValidCourseCodes();
    </script>
</body>
</html>
