<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Collision Checker - Swiss Educational College</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #c8102e;
        }
        .header h1 { color: #c8102e; margin-bottom: 5px; font-size: 1.8em; }
        .header .subtitle { color: #666; font-size: 1.1em; }
        
        .step {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 5px solid #e0e0e0;
            transition: all 0.3s;
        }
        .step.active { border-left-color: #4285f4; }
        .step.complete { border-left-color: #34a853; background: #f8fff8; }
        .step.error { border-left-color: #ea4335; }
        
        .step-header { display: flex; align-items: center; margin-bottom: 15px; }
        .step-number {
            width: 36px; height: 36px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.1em;
            margin-right: 15px;
        }
        .step.active .step-number { background: #4285f4; color: white; }
        .step.complete .step-number { background: #34a853; color: white; }
        .step.complete .step-number::after { content: "‚úì"; }
        .step.complete .step-number span { display: none; }
        
        .step-title { font-size: 1.1em; font-weight: 600; color: #333; }
        .step-content { margin-left: 51px; }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            border: none;
            margin: 5px 5px 5px 0;
            transition: all 0.2s;
        }
        .btn-primary { background: #4285f4; color: white; }
        .btn-primary:hover { background: #3367d6; }
        .btn-success { background: #34a853; color: white; }
        .btn-success:hover { background: #2d8e47; }
        .btn-large { font-size: 16px; padding: 15px 30px; }
        .btn:disabled { background: #ccc !important; cursor: not-allowed; }
        
        .upload-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #4285f4;
            background: #e8f0fe;
        }
        .upload-zone input { display: none; }
        .upload-zone .icon { font-size: 2em; margin-bottom: 10px; }
        
        .status {
            margin: 10px 0;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 14px;
        }
        .status.info { background: #e8f0fe; color: #1967d2; }
        .status.success { background: #e6f4ea; color: #137333; }
        .status.error { background: #fce8e6; color: #c5221f; }
        .status.warning { background: #fef7e0; color: #b06000; }
        .status:empty { display: none; }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        .input-group input:focus {
            outline: none;
            border-color: #4285f4;
        }
        
        .stats { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .stat {
            background: #f1f3f4;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .results-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-top: 20px;
        }
        .results-box h2 { margin: 0 0 10px 0; }
        .results-box .count { font-size: 3em; font-weight: bold; margin: 15px 0; }
        .results-box a {
            display: inline-block;
            background: white;
            color: #667eea;
            padding: 12px 30px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 10px;
        }
        .results-box a:hover { transform: scale(1.05); }
        .results-box.no-collisions { background: linear-gradient(135deg, #34a853 0%, #0d652d 100%); }
        .results-box.no-collisions a { color: #34a853; }
        
        .info-box {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 12px 15px;
            border-radius: 0 6px 6px 0;
            margin: 15px 0;
            font-size: 13px;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
        }
        
        details summary { cursor: pointer; color: #666; font-size: 13px; margin: 10px 0; }
        
        .help-section {
            margin-top: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0;
        }
        .help-section summary {
            padding: 12px 15px;
            margin: 0;
            background: #f1f3f4;
            border-radius: 8px;
        }
        .help-section[open] summary {
            border-radius: 8px 8px 0 0;
        }
        .help-content {
            padding: 15px;
            font-size: 13px;
        }
        .help-content h4 {
            margin: 15px 0 8px 0;
            color: #333;
            font-size: 13px;
        }
        .help-content h4:first-child { margin-top: 0; }
        .help-content ul {
            margin: 0;
            padding-left: 20px;
        }
        .help-content li { margin: 4px 0; }
        .help-content code {
            background: #e8e8e8;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }
        .help-table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
        }
        .help-table td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top;
        }
        .help-table td:first-child {
            width: 140px;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .table-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-top: 10px;
        }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; }
        
        .level-badge {
            display: inline-block; padding: 2px 8px; border-radius: 10px;
            font-size: 10px; font-weight: 500;
        }
        .level-Certificate { background: #fce8e6; color: #c5221f; }
        .level-Diploma { background: #e8f0fe; color: #1967d2; }
        .level-High-Diploma { background: #fef7e0; color: #b06000; }
        .level-BBA { background: #e6f4ea; color: #137333; }
        .level-PGD { background: #f3e8fd; color: #7627bb; }
        .level-MBA { background: #fce8f4; color: #b80672; }
        
        @media (max-width: 600px) {
            .step-content { margin-left: 0; margin-top: 15px; }
            .input-group { flex-direction: column; }
        }
        
        /* Predictor Styles */
        .hidden-feature { display: none; }
        .hidden-feature.visible { display: block; }
        .btn-purple { background: #7c4dff; color: white; }
        .btn-purple:hover { background: #651fff; }
        .btn-secondary { background: #f1f3f4; color: #333; }
        .btn-secondary:hover { background: #e0e0e0; }
        .progression-section { background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%); border: 2px solid #7c4dff; margin-top: 30px; }
        .progression-section .step-number { background: #7c4dff; color: white; }
        .level-English { background: #e3f2fd; color: #1565c0; }
        .level-CUL-I, .level-CUL-II, .level-CUL-III { background: #fff3e0; color: #e65100; }
        .progression-visual { display: flex; flex-wrap: wrap; gap: 6px; padding: 12px; background: white; border-radius: 8px; margin: 10px 0; align-items: center; font-size: 11px; }
        .prog-step { padding: 6px 10px; border-radius: 6px; min-width: 50px; text-align: center; }
        .prog-arrow { color: #999; }
        .prediction-results { background: white; border-radius: 8px; padding: 15px; margin-top: 15px; }
        .prediction-group { margin-bottom: 20px; }
        .prediction-group h4 { margin: 0 0 10px 0; padding-bottom: 8px; border-bottom: 2px solid #eee; display: flex; align-items: center; gap: 10px; }
        .prediction-group h4 .count { background: #f1f3f4; padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        .prediction-group.classlist h4 { color: #1967d2; border-color: #1967d2; }
        .prediction-group.optional h4 { color: #b06000; border-color: #ffc107; }
        .prediction-group.internship h4 { color: #666; border-color: #999; }
        .prediction-group.graduating h4 { color: #7627bb; border-color: #7627bb; }
        .prediction-group.failed h4 { color: #c5221f; border-color: #c5221f; }
        .student-list { max-height: 200px; overflow-y: auto; font-size: 12px; }
        .student-item { display: flex; align-items: center; padding: 6px 10px; background: #f9f9f9; margin: 3px 0; border-radius: 4px; gap: 8px; flex-wrap: wrap; }
        .student-item.has-failed { background: #fce8e6; }
        .student-item .name { font-weight: 500; min-width: 80px; }
        .student-item .email { color: #666; flex: 1; font-size: 11px; }
        .status-tag { padding: 2px 6px; border-radius: 4px; font-size: 10px; }
        .status-tag.term1 { background: #e8f0fe; color: #1967d2; }
        .status-tag.term2 { background: #e6f4ea; color: #137333; }
        .status-tag.returning { background: #fff3e0; color: #e65100; }
        .grade-tag { padding: 2px 6px; border-radius: 4px; font-size: 10px; }
        .grade-tag.passed { background: #e6f4ea; color: #137333; }
        .grade-tag.failed { background: #fce8e6; color: #c5221f; }
        .grade-tag.none { background: #f1f3f4; color: #666; }
        .auto-detected { background: #e6f4ea; border: 1px solid #34a853; padding: 12px 15px; border-radius: 6px; margin: 15px 0; }
        .session-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; }
        .session-box { background: white; padding: 8px; border-radius: 6px; text-align: center; }
        .session-box .label { font-size: 10px; color: #666; }
        .session-box .value { font-size: 16px; font-weight: bold; }
        .session-box.highlight { background: #7c4dff; }
        .session-box.highlight .label, .session-box.highlight .value { color: white; }
        .export-btn { background: #34a853; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; margin: 5px; }
        .export-btn:hover { background: #2d8e47; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìö Course Collision Checker</h1>
        <p class="subtitle">Check if returning students have already taken their scheduled courses</p>
    </div>

    <!-- STEP 1: Upload PDF -->
    <div class="step active" id="step1">
        <div class="step-header">
            <div class="step-number"><span>1</span></div>
            <div class="step-title">Upload Timetable PDF</div>
        </div>
        <div class="step-content">
            <div class="upload-zone" id="uploadZone">
                <input type="file" id="pdfInput" accept=".pdf">
                <div class="icon">üìÑ</div>
                <p><strong>Drop PDF here</strong> or click to browse</p>
            </div>
            <div id="step1Status" class="status"></div>
            <div id="courseStats" class="stats"></div>
            
            <div id="sendCoursesSection" style="display: none; margin-top: 15px;">
                <button class="btn btn-success btn-large" onclick="sendCourses()" id="sendCoursesBtn">
                    üì§ Send Courses to Google Sheet
                </button>
            </div>
            
            <details id="courseDetails" style="display: none;">
                <summary>üìë View extracted courses</summary>
                <div class="table-container" id="courseTable"></div>
            </details>
            
            <details class="help-section" style="margin-top: 15px;">
                <summary>‚ùì PDF not working?</summary>
                <div class="help-content">
                    <h4>What this tool extracts:</h4>
                    <ul>
                        <li><strong>Course codes</strong> like <code>1022B</code>, <code>2040A</code> (4 digits + letter)</li>
                        <li><strong>Level</strong> from the page header (Certificate, Diploma, MBA, etc.)</li>
                    </ul>
                    <p>Course names come from the raw grade data, not the PDF.</p>
                    
                    <h4>If courses show "Unknown" level:</h4>
                    <p>The page header couldn't be detected. Verify the level manually in the Courses tab after sending.</p>
                    
                    <h4>Expected PDF format:</h4>
                    <p>Timetable PDFs from <strong>aSc Timetables</strong> with each page/section labeled by level in the header.</p>
                </div>
            </details>
        </div>
    </div>

    <!-- STEP 2: Import Students -->
    <div class="step" id="step2">
        <div class="step-header">
            <div class="step-number"><span>2</span></div>
            <div class="step-title">Import Class List</div>
        </div>
        <div class="step-content">
            <p>Paste the Google Sheet URL containing your class list:</p>
            <div class="input-group">
                <input type="text" id="studentsUrl" placeholder="https://docs.google.com/spreadsheets/d/xxxxx/edit#gid=0">
                <button class="btn btn-primary" onclick="importStudents()" id="importStudentsBtn">üì• Import</button>
            </div>
            <div id="step2Status" class="status"></div>
            
            <details class="help-section">
                <summary>‚ùì Help & Troubleshooting</summary>
                <div class="help-content">
                    <h4>Required columns:</h4>
                    <ul>
                        <li><strong>Class</strong> ‚Äî containing level info like <code>26-T1-Class-Certificate</code></li>
                        <li><strong>School Email</strong> ‚Äî student email addresses</li>
                    </ul>
                    
                    <h4>Common issues:</h4>
                    <table class="help-table">
                        <tr>
                            <td>‚ùå "Cannot access"</td>
                            <td>Sheet isn't shared. Click <strong>Share ‚Üí Anyone with link ‚Üí Viewer</strong></td>
                        </tr>
                        <tr>
                            <td>‚ùå "Invalid URL"</td>
                            <td>Copy the full URL from your browser address bar</td>
                        </tr>
                        <tr>
                            <td>‚ùå "Missing columns"</td>
                            <td>Make sure headers include "Class" and "Email" (case-insensitive)</td>
                        </tr>
                        <tr>
                            <td>‚ö†Ô∏è "Could not detect level"</td>
                            <td>Class column should have format like <code>26-T1-Class-Diploma</code></td>
                        </tr>
                    </table>
                    
                    <h4>Accepted column names:</h4>
                    <p><strong>For Class:</strong> Class, Student Class, Level, Program</p>
                    <p><strong>For Email:</strong> School Email, Email, Student Email, E-mail</p>
                </div>
            </details>
        </div>
    </div>

    <!-- STEP 3: Update Raw Data -->
    <div class="step" id="step3">
        <div class="step-header">
            <div class="step-number"><span>3</span></div>
            <div class="step-title">Update Historical Grade Data</div>
        </div>
        <div class="step-content">
            <p>Import the latest grade records from the nightly backup:</p>
            <button class="btn btn-primary" onclick="updateRaw()" id="updateRawBtn">üîÑ Update Raw Data</button>
            <button class="btn" style="background: #f1f3f4; color: #333;" onclick="skipStep3()" id="skipStep3Btn">Skip (use existing) ‚Üí</button>
            <div id="step3Status" class="status"></div>
            
            <div class="info-box">
                <strong>‚ö†Ô∏è Required on first use</strong> or if grades have changed.<br>
                <span style="color: #666;">Skip only if you've already updated raw data recently. The backup updates nightly at 3:00 AM.</span>
            </div>
        </div>
    </div>

    <!-- STEP 4: Check Collisions -->
    <div class="step" id="step4">
        <div class="step-header">
            <div class="step-number"><span>4</span></div>
            <div class="step-title">Check for Collisions</div>
        </div>
        <div class="step-content">
            <p>Run the collision check to find students who have already taken their scheduled courses:</p>
            <button class="btn btn-success btn-large" onclick="checkCollisions()" id="checkBtn">üîç Check for Collisions</button>
            <div id="step4Status" class="status"></div>
            
            <details class="help-section" style="margin-top: 15px;">
                <summary>‚ùì How collision detection works</summary>
                <div class="help-content">
                    <h4>What counts as a collision?</h4>
                    <p>A student has a <strong>collision</strong> if they have at least one <strong>actual grade recorded</strong> (non-empty "Contribution %") for a scheduled course.</p>
                    <ul>
                        <li>Students enrolled but with <strong>no grades</strong> ‚Üí NOT a collision</li>
                        <li>Students with <strong>0% grade</strong> ‚Üí IS a collision (0 is still a grade)</li>
                        <li>Students with <strong>any grade value</strong> ‚Üí IS a collision</li>
                    </ul>
                    
                    <h4>Grade calculation:</h4>
                    <p>The grade shown is the <strong>SUM</strong> of all "Contribution %" values for each student+course+session.</p>
                    
                    <h4>Quick filters:</h4>
                    <p>In Google Sheets, use <strong>Collision Checker ‚Üí Quick Filters</strong> to instantly filter:</p>
                    <ul>
                        <li>‚ö†Ô∏è 0-59% (Insufficient)</li>
                        <li>‚úì 60-100% (Passed)</li>
                        <li>Show All</li>
                    </ul>
                    
                    <h4>Filtering results:</h4>
                    <p>Each column header (row 4) has a dropdown filter. Click to filter by level, course, grade, etc.</p>
                    <p><strong>To save a filter:</strong> In Google Sheets, go to <em>Data ‚Üí Filter views ‚Üí Create new filter view</em>.</p>
                    
                    <h4>Color coding in results:</h4>
                    <table class="help-table">
                        <tr>
                            <td style="background: #fef7e0;">‚ö†Ô∏è Orange</td>
                            <td>Total grade <60% - insufficient, may need academic review</td>
                        </tr>
                        <tr>
                            <td style="background: #fce8e6;">‚úì Red</td>
                            <td>Total grade ‚â•60% - passed, cannot retake course</td>
                        </tr>
                    </table>
                    
                    <h4>If results are unexpected:</h4>
                    <ul>
                        <li>Check that course codes match exactly (e.g., <code>2040A</code> vs <code>2040B</code>)</li>
                        <li>Verify student emails are identical in both the class list and raw data</li>
                        <li>Ensure raw data is current (click "Update Raw Data" in Step 3)</li>
                    </ul>
                    
                    <h4>Want to check manually?</h4>
                    <p>Open the <a href="https://docs.google.com/spreadsheets/d/1omcWpajVrVMTWiOdKL5YQr40KxlRHCogJpfKuRUsdWY/edit" target="_blank">full spreadsheet</a> to see all tabs.</p>
                </div>
            </details>
        </div>
    </div>

    <!-- Results -->
    <div id="resultsSection" style="display: none;"></div>

    <!-- Predictor Toggle -->
    <div style="text-align: center; margin: 20px 0;">
        <button class="btn btn-secondary" onclick="togglePredictor()" id="predictorToggle" style="opacity: 0.6;">
            üîÆ Predict Next Term Class List
        </button>
    </div>

    <!-- PROGRESSION PREDICTOR -->
    <div class="step progression-section hidden-feature" id="progressionSection">
        <div class="step-header">
            <div class="step-number"><span>üîÆ</span></div>
            <div class="step-title">Student Progression Predictor</div>
        </div>
        <div class="step-content">
            <p>Predict who will be on the next term's class list, with grade verification from raw data.</p>
            
            <details class="help-section">
                <summary>üìã Progression Rules</summary>
                <div class="help-content">
                    <h4>Business Track:</h4>
                    <div class="progression-visual">
                        <div class="prog-step level-English">English(1)</div><div class="prog-arrow">‚Üí</div>
                        <div class="prog-step level-Certificate">Cert(2)</div><div class="prog-arrow">‚Üíüì¶‚Üí</div>
                        <div class="prog-step level-Diploma">Dip(2)</div><div class="prog-arrow">‚Üíüì¶‚Üí</div>
                        <div class="prog-step level-High-Diploma">HD(2)</div><div class="prog-arrow">‚Üíüì¶‚Üí</div>
                        <div class="prog-step level-BBA">BBAüéì</div><div class="prog-arrow">‚Üíüì¶‚Üí</div>
                        <div class="prog-step level-PGD">PGD(2)</div><div class="prog-arrow">‚Üíüì¶‚Üí</div>
                        <div class="prog-step level-MBA">MBAüéì</div>
                    </div>
                    <h4>Culinary Track:</h4>
                    <div class="progression-visual">
                        <div class="prog-step level-CUL-I">CUL I(2)</div><div class="prog-arrow">‚Üíüì¶‚Üí</div>
                        <div class="prog-step level-CUL-II">CUL II(2)</div><div class="prog-arrow">‚Üíüì¶‚Üí</div>
                        <div class="prog-step level-CUL-III">CUL III</div>
                    </div>
                    <p style="font-size:11px;color:#666;">üì¶ = 2 terms internship | üéì = Degree | (n) = terms | Pass ‚â•60%</p>
                    <h4>Key Rules:</h4>
                    <ul>
                        <li><strong>English</strong> is 1 term, then Certificate (no internship gap)</li>
                        <li><strong>BBA grads</strong> can choose to continue to PGD or stop</li>
                        <li><strong>MBA/CUL III</strong> are finished (final level)</li>
                        <li><strong>Returning students</strong> found by looking 2 terms back</li>
                    </ul>
                </div>
            </details>

            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 8px;">
                <h4 style="margin-top: 0;">üì• Load Data</h4>
                <p style="font-size: 12px; color: #666;">Loads Master Class List and Raw Grades from Google Sheets (same data as collision checker).</p>
                <button class="btn btn-purple btn-large" onclick="loadPredictionData()" id="loadPredBtn">
                    üìä Load Master List & Grades
                </button>
                <div id="predLoadStatus" class="status"></div>
            </div>
            
            <div id="predDataSection" style="display: none;">
                <div class="auto-detected">
                    <strong>‚úì Data Loaded</strong>
                    <div class="session-info">
                        <div class="session-box"><div class="label">Current</div><div class="value" id="dispCurrent">--</div></div>
                        <div class="session-box"><div class="label">Students</div><div class="value" id="dispCount">--</div></div>
                        <div class="session-box highlight"><div class="label">Predicting</div><div class="value" id="dispNext">--</div></div>
                        <div class="session-box"><div class="label">Return From</div><div class="value" id="dispReturn">--</div></div>
                    </div>
                </div>
                <button class="btn btn-purple btn-large" onclick="generatePrediction()">üîÆ Generate Prediction</button>
            </div>

            <div id="predictionResults" style="display: none;"></div>
        </div>
    </div>

    <div class="footer">
        Swiss Educational College ‚Ä¢ Course Collision Checker<br>
        <small>Supported Levels: Certificate, Diploma, High Diploma, BBA, PGD, MBA, CUL I, CUL II</small>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzD-Fsbe8g4eXlwIE-VYpOFIxCftbchaxyYXafgWRfn7nzLz3n7feLo6G8zXqx14eb2/exec';
        
        let extractedCourses = [];
        let pdfFileName = '';

        // ========== PDF PARSING ==========
        
        // Valid course codes - will be fetched from raw data
        let validCourseCodes = new Set();
        
        // Course code pattern: optional C prefix + 4 digits + optional space/parens + letter
        // Handles: 1022B, C3044B, (1111B), 3046(B)
        const COURSE_CODE_PATTERN = /\(?(C?)(\d{4})\s*\(?([A-Z])\)?\)?/g;

        async function fetchValidCourseCodes() {
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getCourseCodes`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.codes && Array.isArray(data.codes)) {
                        validCourseCodes = new Set(data.codes.map(c => c.toUpperCase()));
                        console.log('Loaded', validCourseCodes.size, 'valid course codes from raw data');
                        // Show small indicator
                        const step1 = document.getElementById('step1Status');
                        if (step1 && !step1.innerHTML) {
                            step1.innerHTML = `<small style="color:#666;">‚úì ${validCourseCodes.size} valid course codes loaded</small>`;
                        }
                    }
                }
            } catch (e) {
                console.log('Could not fetch valid course codes, will accept all patterns:', e);
            }
        }

        function isValidCourseCode(code) {
            // If we don't have validation data, accept all
            if (validCourseCodes.size === 0) return true;
            
            // Check exact match
            if (validCourseCodes.has(code)) return true;
            
            // If C-prefixed, check if base code exists
            if (code.startsWith('C')) {
                const baseCode = code.substring(1);
                if (validCourseCodes.has(baseCode)) return true;
            }
            
            return false;
        }

        function extractCourseName(text, code) {
            // Course names will come from raw data - just return empty here
            return '';
        }

        function detectLevel(pageText) {
            // Check first 200 chars for level (title area only)
            const header = pageText.substring(0, 200).toUpperCase();
            
            // Check CUL variants first (most specific)
            if (header.includes('CUL II')) return 'CUL II';
            if (header.includes('CUL I') && !header.includes('CUL II')) return 'CUL I';
            
            // Check other levels
            if (header.includes('HIGH DIPLOMA')) return 'High Diploma';
            if (header.includes('DIPLOMA') && !header.includes('HIGH')) return 'Diploma';
            if (header.includes('CERTIFICATE')) return 'Certificate';
            if (header.includes('MBA')) return 'MBA';
            if (header.includes('BBA')) return 'BBA';
            if (header.includes('PGD')) return 'PGD';
            if (header.includes('ENGLISH')) return 'English';
            
            return 'Unknown';
        }

        async function parsePDF(file) {
            setStatus('step1Status', 'info', '‚è≥ Processing PDF...');
            pdfFileName = file.name; // Store filename
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                const allCourses = new Map();
                const levelStats = {};

                for (let i = 1; i <= pdf.numPages; i++) {
                    setStatus('step1Status', 'info', `‚è≥ Processing page ${i} of ${pdf.numPages}...`);
                    
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    
                    const level = detectLevel(pageText);
                    
                    // Find all course codes
                    let match;
                    const courseCodesFound = new Set();
                    const rejectedCodes = new Set(); // For debugging
                    
                    // Reset regex
                    COURSE_CODE_PATTERN.lastIndex = 0;
                    
                    while ((match = COURSE_CODE_PATTERN.exec(pageText)) !== null) {
                        const prefix = match[1] || ''; // C or empty
                        const digits = match[2];
                        const letter = match[3].toUpperCase();
                        const matchStart = match.index;
                        
                        // Get context: 5 chars before the match
                        const contextBefore = pageText.substring(Math.max(0, matchStart - 5), matchStart);
                        
                        // Skip if looks like a date (preceded by . or / and digits)
                        // e.g., "29.01.2026" or "01/2026"
                        if (/[\d][.\/]$/.test(contextBefore)) {
                            continue;
                        }
                        
                        // Build the code exactly as found in PDF
                        const code = prefix + digits + letter;
                        
                        // Validate against known codes from raw data
                        if (isValidCourseCode(code)) {
                            courseCodesFound.add(code);
                        } else {
                            rejectedCodes.add(code);
                        }
                    }
                    
                    // Log rejected codes for debugging
                    if (rejectedCodes.size > 0) {
                        console.log('Page', i, 'rejected codes:', [...rejectedCodes].join(', '));
                    }
                    
                    for (const code of courseCodesFound) {
                        const name = extractCourseName(pageText, code);
                        if (!allCourses.has(code)) {
                            allCourses.set(code, { name, levels: new Set() });
                        } else if (name && !allCourses.get(code).name) {
                            allCourses.get(code).name = name;
                        }
                        if (level !== 'Unknown') {
                            allCourses.get(code).levels.add(level);
                        }
                    }
                }

                extractedCourses = [];
                allCourses.forEach((data, code) => {
                    const levels = data.levels.size > 0 ? [...data.levels] : ['Unknown'];
                    for (const level of levels) {
                        extractedCourses.push({ code, name: data.name || '', level });
                        levelStats[level] = (levelStats[level] || 0) + 1;
                    }
                });
                extractedCourses.sort((a, b) => a.level.localeCompare(b.level) || a.code.localeCompare(b.code));

                // Display stats
                document.getElementById('courseStats').innerHTML = Object.entries(levelStats)
                    .map(([level, count]) => `<div class="stat"><strong>${level}:</strong> ${count}</div>`).join('');
                
                // Count coursework courses (those with C prefix)
                const courseworkCount = extractedCourses.filter(c => c.code.startsWith('C')).length;
                const regularCount = extractedCourses.length - courseworkCount;
                
                // Display table
                let html = '<table><thead><tr><th>Code</th><th>Level</th></tr></thead><tbody>';
                for (const c of extractedCourses) {
                    const levelClass = 'level-' + c.level.replace(/\s+/g, '-');
                    const isCoursework = c.code.startsWith('C');
                    const codeStyle = isCoursework ? 'color: #666; font-style: italic;' : '';
                    html += `<tr><td><strong style="${codeStyle}">${c.code}</strong></td><td><span class="level-badge ${levelClass}">${c.level}</span></td></tr>`;
                }
                html += '</tbody></table>';
                
                let infoMsg = '<p style="font-size: 11px; color: #666; margin-top: 8px;">‚ÑπÔ∏è Course names will be added from grade records.</p>';
                if (courseworkCount > 0) {
                    infoMsg += `<p style="font-size: 11px; color: #666;">üìö Found ${courseworkCount} C-prefixed codes (coursework/self-study) and ${regularCount} regular codes.</p>`;
                }
                if (validCourseCodes.size > 0) {
                    infoMsg += `<p style="font-size: 11px; color: #137333;">‚úì Validated against ${validCourseCodes.size} known codes from raw data.</p>`;
                }
                document.getElementById('courseTable').innerHTML = html + infoMsg;
                
                document.getElementById('sendCoursesSection').style.display = 'block';
                document.getElementById('courseDetails').style.display = 'block';
                
                setStatus('step1Status', 'success', `‚úÖ Extracted ${extractedCourses.length} courses from ${pdf.numPages} pages`);
                
            } catch (error) {
                setStatus('step1Status', 'error', `‚ùå Error: ${error.message}`);
            }
        }

        // ========== API CALLS ==========
        
        async function sendCourses() {
            if (!extractedCourses || extractedCourses.length === 0) {
                setStatus('step1Status', 'error', '‚ö†Ô∏è No courses extracted. Please upload a PDF first.');
                return;
            }
            
            const btn = document.getElementById('sendCoursesBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Sending...';
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);
                
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'importCourses', 
                        courses: extractedCourses,
                        pdfName: pdfFileName
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                // Check for unknown levels
                const unknownCount = extractedCourses.filter(c => c.level === 'Unknown').length;
                if (unknownCount > 0) {
                    setStatus('step1Status', 'warning', `‚ö†Ô∏è ${extractedCourses.length} courses sent, but ${unknownCount} have "Unknown" level. You may want to check the Courses tab.`);
                } else {
                    setStatus('step1Status', 'success', `‚úÖ ${extractedCourses.length} courses sent to Google Sheet!`);
                }
                
                completeStep('step1');
                activateStep('step2');
                btn.textContent = '‚úÖ Sent!';
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    setStatus('step1Status', 'error', '‚ö†Ô∏è Request timed out. Please try again.');
                } else {
                    setStatus('step1Status', 'error', '‚ùå Network error. Check your internet connection.');
                }
                btn.textContent = 'üì§ Send Courses to Google Sheet';
                btn.disabled = false;
            }
        }
        
        async function importStudents() {
            const url = document.getElementById('studentsUrl').value.trim();
            
            // Client-side validation
            if (!url) {
                setStatus('step2Status', 'error', '‚ö†Ô∏è Please paste a Google Sheet URL');
                return;
            }
            
            // Check if it looks like a Google Sheets URL
            const isGoogleUrl = url.includes('docs.google.com/spreadsheets') || 
                               url.includes('sheets.google.com') ||
                               url.match(/^[a-zA-Z0-9-_]{20,}$/); // Just the ID
            
            if (!isGoogleUrl) {
                setStatus('step2Status', 'error', '‚ö†Ô∏è This doesn\'t look like a Google Sheets URL. Please copy the full URL from your browser.');
                return;
            }
            
            const btn = document.getElementById('importStudentsBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥...';
            setStatus('step2Status', 'info', '‚è≥ Importing students... (this may take a few seconds)');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout
                
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'importStudents', url }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                // With no-cors we can't read response, wait and assume success
                await new Promise(r => setTimeout(r, 3000));
                
                setStatus('step2Status', 'success', '‚úÖ Import request sent! If your sheet was shared correctly, students are now imported. Check Step 4 for any errors.');
                completeStep('step2');
                activateStep('step3');
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    setStatus('step2Status', 'error', '‚ö†Ô∏è Request timed out. The server may be busy - please try again.');
                } else {
                    setStatus('step2Status', 'error', '‚ùå Network error. Check your internet connection and try again.');
                }
            }
            
            btn.disabled = false;
            btn.textContent = 'üì• Import';
        }
        
        async function updateRaw() {
            const btn = document.getElementById('updateRawBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Updating...';
            setStatus('step3Status', 'info', '‚è≥ Fetching latest backup... This may take 10-30 seconds for large files.');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60s for large CSV
                
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'updateRaw' }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                await new Promise(r => setTimeout(r, 5000));
                
                setStatus('step3Status', 'success', '‚úÖ Raw data updated from latest backup!');
                completeStep('step3');
                activateStep('step4');
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    setStatus('step3Status', 'warning', '‚ö†Ô∏è Request timed out, but it may still be processing. Try running the collision check.');
                } else {
                    setStatus('step3Status', 'error', '‚ùå Network error. Check your internet connection.');
                }
            }
            
            btn.disabled = false;
            btn.textContent = 'üîÑ Update Raw Data';
        }
        
        async function checkCollisions() {
            const btn = document.getElementById('checkBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Checking...';
            setStatus('step4Status', 'info', '‚è≥ Running collision check... This may take 10-20 seconds for large datasets.');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60s timeout for large datasets
                
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'checkCollisions' }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                // Wait for processing
                await new Promise(r => setTimeout(r, 5000));
                
                setStatus('step4Status', 'success', '‚úÖ Collision check complete! Click the button below to view results.');
                completeStep('step4');
                
                // Show results link
                document.getElementById('resultsSection').innerHTML = `
                    <div class="results-box">
                        <h2>üéâ Check Complete!</h2>
                        <p>View the results in Google Sheets:</p>
                        <a href="https://docs.google.com/spreadsheets/d/1omcWpajVrVMTWiOdKL5YQr40KxlRHCogJpfKuRUsdWY/edit?gid=808012596#gid=808012596" target="_blank">
                            üìä Open Results Tab
                        </a>
                        <p style="margin-top: 15px; font-size: 13px; opacity: 0.9;">
                            <strong>Orange rows</strong> = collision with insufficient grade (<60%)<br>
                            <strong>Red rows</strong> = collision with passing grade (‚â•60%)<br>
                            <strong>Tip:</strong> Use column filters (row 4) to show/hide results. Create a <em>Filter View</em> to save your filter settings.
                        </p>
                    </div>
                `;
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    setStatus('step4Status', 'error', '‚ö†Ô∏è Request timed out. The dataset may be very large. Check the Results tab anyway - it may have completed.');
                } else {
                    setStatus('step4Status', 'error', '‚ùå Network error. Check your internet connection and try again.');
                }
                btn.disabled = false;
                btn.textContent = 'üîç Check for Collisions';
                return;
            }
            
            btn.disabled = false;
            btn.textContent = 'üîç Run Again';
        }

        // ========== HELPERS ==========
        
        function setStatus(id, type, message) {
            const el = document.getElementById(id);
            el.className = 'status ' + type;
            el.textContent = message;
        }
        
        function completeStep(stepId) {
            document.getElementById(stepId).classList.remove('active');
            document.getElementById(stepId).classList.add('complete');
        }
        
        function activateStep(stepId) {
            document.getElementById(stepId).classList.add('active');
        }
        
        function skipStep3() {
            setStatus('step3Status', 'warning', '‚è≠Ô∏è Skipped ‚Äî using existing raw data. If collision check fails, come back and update.');
            document.getElementById('step3').classList.remove('active');
            activateStep('step4');
        }

        // ========== FILE UPLOAD ==========
        
        const uploadZone = document.getElementById('uploadZone');
        const pdfInput = document.getElementById('pdfInput');

        uploadZone.addEventListener('click', () => pdfInput.click());
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files[0]?.type === 'application/pdf') parsePDF(e.dataTransfer.files[0]);
        });
        pdfInput.addEventListener('change', (e) => { if (e.target.files[0]) parsePDF(e.target.files[0]); });
        
        // Fetch valid course codes from raw data on page load
        fetchValidCourseCodes();
        
        // ========== PROGRESSION PREDICTOR ==========
        
        const BUSINESS_TRACK = ['English', 'Certificate', 'Diploma', 'High Diploma', 'BBA', 'PGD', 'MBA'];
        const CULINARY_TRACK = ['CUL I', 'CUL II', 'CUL III'];
        const FINAL_LEVELS = ['MBA', 'CUL III'];
        const OPTIONAL_CONTINUE = ['BBA'];
        const PASS_THRESHOLD = 60;
        
        let masterData = {};
        let rawGrades = {};
        let currentSession = null;
        
        function togglePredictor() {
            const section = document.getElementById('progressionSection');
            const btn = document.getElementById('predictorToggle');
            if (section.classList.contains('visible')) {
                section.classList.remove('visible');
                btn.textContent = 'üîÆ Predict Next Term Class List';
                btn.style.opacity = '0.6';
            } else {
                section.classList.add('visible');
                btn.textContent = 'üîÆ Hide Prediction Tool';
                btn.style.opacity = '1';
                section.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        function parseSession(str) {
            const m = str?.match(/(\d{2})-T(\d)/);
            return m ? { year: parseInt(m[1]), term: parseInt(m[2]), str } : null;
        }
        
        function parseClass(str) {
            const m = str?.match(/(\d{2})-T(\d)-Class-(.+)/i);
            return m ? { year: parseInt(m[1]), term: parseInt(m[2]), level: m[3].trim() } : null;
        }
        
        function sessionToNum(s) { return s.year * 4 + s.term; }
        function formatSession(y, t) { return `${y}-T${t}`; }
        
        function getNextSession(s) {
            let y = s.year, t = s.term + 1;
            if (t > 4) { t = 1; y++; }
            return { year: y, term: t, str: formatSession(y, t) };
        }
        
        function getPrevSession(s, n = 1) {
            let y = s.year, t = s.term;
            for (let i = 0; i < n; i++) { t--; if (t < 1) { t = 4; y--; } }
            return { year: y, term: t, str: formatSession(y, t) };
        }
        
        function getNextLevel(level) {
            const track = CULINARY_TRACK.some(l => level.toUpperCase().includes(l.replace(' ',''))) ? CULINARY_TRACK : BUSINESS_TRACK;
            const idx = track.findIndex(l => l.toUpperCase() === level.toUpperCase());
            return (idx >= 0 && idx < track.length - 1) ? track[idx + 1] : null;
        }
        
        function normalizeLevel(level) {
            if (/^CUL\s*III$/i.test(level)) return 'CUL III';
            if (/^CUL\s*II$/i.test(level)) return 'CUL II';
            if (/^CUL\s*I$/i.test(level)) return 'CUL I';
            return level;
        }
        
        async function loadPredictionData() {
            const btn = document.getElementById('loadPredBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Loading...';
            setStatus('predLoadStatus', 'info', '‚è≥ Loading Master List...');
            
            try {
                // Load Master List
                const masterResp = await fetch(`${WEB_APP_URL}?action=getMasterListData`);
                const masterJson = await masterResp.json();
                
                if (masterJson.status !== 'success') throw new Error(masterJson.message || 'Failed to load master list');
                
                const data = masterJson.data;
                const headers = data[0].map(h => String(h).toLowerCase().trim());
                const sessionIdx = headers.indexOf('session');
                const classIdx = headers.findIndex(h => h === 'class');
                const emailIdx = headers.findIndex(h => h.includes('school email') || (h.includes('email') && !h.includes('recovery')));
                const firstNameIdx = headers.findIndex(h => h.includes('first name'));
                const callNameIdx = headers.findIndex(h => h.includes('call name'));
                
                if (sessionIdx < 0 || classIdx < 0 || emailIdx < 0) throw new Error('Missing columns: Session, Class, Email');
                
                // Parse students by session
                masterData = {};
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    const sessionStr = String(row[sessionIdx] || '').trim();
                    const classStr = String(row[classIdx] || '').trim();
                    const email = String(row[emailIdx] || '').trim().toLowerCase();
                    if (!sessionStr || !classStr || !email) continue;
                    
                    const session = parseSession(sessionStr);
                    const classInfo = parseClass(classStr);
                    if (!session || !classInfo) continue;
                    
                    if (!masterData[sessionStr]) masterData[sessionStr] = [];
                    
                    const termNum = sessionToNum(session) - sessionToNum({year: classInfo.year, term: classInfo.term}) + 1;
                    let name = callNameIdx >= 0 && row[callNameIdx] ? String(row[callNameIdx]).trim() : (firstNameIdx >= 0 ? String(row[firstNameIdx] || '').trim() : '');
                    
                    masterData[sessionStr].push({
                        email, name, sessionStr, classStr,
                        level: normalizeLevel(classInfo.level),
                        classYear: classInfo.year, classTerm: classInfo.term, termNumber: termNum
                    });
                }
                
                // Find current session (latest)
                const sessions = Object.keys(masterData).sort((a, b) => {
                    const sa = parseSession(a), sb = parseSession(b);
                    return sessionToNum(sa) - sessionToNum(sb);
                });
                if (sessions.length === 0) throw new Error('No session data found');
                
                currentSession = parseSession(sessions[sessions.length - 1]);
                
                setStatus('predLoadStatus', 'info', '‚è≥ Loading Raw Grades...');
                
                // Load Raw Grades
                const rawResp = await fetch(`${WEB_APP_URL}?action=getRawGradesData`);
                const rawJson = await rawResp.json();
                
                rawGrades = {};
                if (rawJson.status === 'success' && rawJson.data) {
                    const rawData = rawJson.data;
                    const rawHeaders = rawData[0].map(h => String(h).toLowerCase().trim());
                    const rEmailIdx = rawHeaders.findIndex(h => h.includes('email'));
                    const rSessionIdx = rawHeaders.findIndex(h => h === 'session');
                    const rCodeIdx = rawHeaders.findIndex(h => h.includes('course code'));
                    const rContribIdx = rawHeaders.findIndex(h => h.includes('contribution'));
                    
                    if (rEmailIdx >= 0 && rContribIdx >= 0) {
                        for (let i = 1; i < rawData.length; i++) {
                            const row = rawData[i];
                            const email = String(row[rEmailIdx] || '').trim().toLowerCase();
                            const session = rSessionIdx >= 0 ? String(row[rSessionIdx] || '').trim() : '';
                            const code = rCodeIdx >= 0 ? String(row[rCodeIdx] || '').trim().toUpperCase() : '';
                            const contrib = parseFloat(row[rContribIdx]);
                            if (!email || isNaN(contrib)) continue;
                            
                            if (!rawGrades[email]) rawGrades[email] = {};
                            if (!rawGrades[email][session]) rawGrades[email][session] = {};
                            if (!rawGrades[email][session][code]) rawGrades[email][session][code] = 0;
                            rawGrades[email][session][code] += contrib;
                        }
                    }
                }
                
                // Update display
                const nextSession = getNextSession(currentSession);
                const returnSession = getPrevSession(currentSession, 2);
                document.getElementById('dispCurrent').textContent = currentSession.str;
                document.getElementById('dispCount').textContent = masterData[currentSession.str]?.length || 0;
                document.getElementById('dispNext').textContent = nextSession.str;
                document.getElementById('dispReturn').textContent = returnSession.str;
                
                document.getElementById('predDataSection').style.display = 'block';
                setStatus('predLoadStatus', 'success', `‚úÖ Loaded ${data.length - 1} students, ${Object.keys(rawGrades).length} with grades`);
                
            } catch (error) {
                setStatus('predLoadStatus', 'error', '‚ùå ' + error.message);
            }
            
            btn.disabled = false;
            btn.textContent = 'üìä Load Master List & Grades';
        }
        
        function getStudentGrades(email, sessions) {
            const studentGrades = rawGrades[email.toLowerCase()];
            if (!studentGrades) return { found: false, failed: [], avg: null };
            
            const failed = [];
            let total = 0, count = 0;
            
            for (const sess of sessions) {
                const sessGrades = studentGrades[sess];
                if (!sessGrades) continue;
                for (const [code, grade] of Object.entries(sessGrades)) {
                    total += grade; count++;
                    if (grade < PASS_THRESHOLD) failed.push({ code, grade: Math.round(grade), session: sess });
                }
            }
            
            return { found: count > 0, failed, avg: count > 0 ? Math.round(total / count) : null, allPassed: failed.length === 0 && count > 0 };
        }
        
        function generatePrediction() {
            if (!currentSession || Object.keys(masterData).length === 0) {
                alert('Please load data first');
                return;
            }
            
            const nextSession = getNextSession(currentSession);
            const returnFromSession = getPrevSession(currentSession, 2);
            
            const currentStudents = masterData[currentSession.str] || [];
            const twoTermsAgo = masterData[returnFromSession.str] || [];
            
            const continuing = [], toInternship = [], graduating = [], optionalReturn = [], returning = [], failedGrades = [];
            const currentEmails = new Set();
            
            // Process current students
            for (const s of currentStudents) {
                currentEmails.add(s.email);
                
                if (s.level === 'English') {
                    continuing.push({...s, nextLevel: 'Certificate', nextClass: `${nextSession.str}-Class-Certificate`, reason: 'English‚ÜíCertificate'});
                } else if (s.termNumber === 1) {
                    continuing.push({...s, nextLevel: s.level, nextClass: `${nextSession.str}-Class-${s.level}`, reason: 'Term 1‚Üí2'});
                } else {
                    // Term 2 - check grades
                    const studySessions = [formatSession(s.classYear, s.classTerm), getNextSession({year: s.classYear, term: s.classTerm}).str];
                    const gradeInfo = getStudentGrades(s.email, studySessions);
                    
                    if (FINAL_LEVELS.includes(s.level)) {
                        graduating.push({...s, reason: `${s.level} üéì`, gradeInfo});
                    } else if (OPTIONAL_CONTINUE.includes(s.level)) {
                        optionalReturn.push({...s, nextLevel: getNextLevel(s.level), reason: 'BBA - optional PGD', gradeInfo});
                    } else {
                        const next = getNextLevel(s.level);
                        toInternship.push({...s, nextLevel: next, reason: `‚Üíüì¶‚Üí${next}`, gradeInfo});
                        if (gradeInfo.found && !gradeInfo.allPassed) failedGrades.push({...s, gradeInfo});
                    }
                }
            }
            
            // Find returning students
            for (const s of twoTermsAgo) {
                if (currentEmails.has(s.email)) continue;
                if (s.termNumber >= 2 && !FINAL_LEVELS.includes(s.level) && !OPTIONAL_CONTINUE.includes(s.level)) {
                    const nextLevel = getNextLevel(s.level);
                    if (nextLevel) {
                        const studySessions = [formatSession(s.classYear, s.classTerm), getNextSession({year: s.classYear, term: s.classTerm}).str];
                        const gradeInfo = getStudentGrades(s.email, studySessions);
                        returning.push({...s, nextLevel, nextClass: `${nextSession.str}-Class-${nextLevel}`, reason: `Return‚Üí${nextLevel}`, gradeInfo});
                        if (gradeInfo.found && !gradeInfo.allPassed) failedGrades.push({...s, gradeInfo});
                    }
                }
            }
            
            // Store for saving
            const onClassList = [...continuing, ...returning];
            window.predictionData = { term: nextSession.str, onClassList, optionalReturn, toInternship, graduating, failedGrades };
            
            // Save to Google Sheet
            savePredictionToSheet(window.predictionData);
            
            // Build HTML
            let html = `<div class="prediction-results"><h3>üìä Predicted for ${nextSession.str}</h3>`;
            
            const renderStudent = (s, showGrade = false) => {
                const hasFailed = s.gradeInfo && !s.gradeInfo.allPassed && s.gradeInfo.found;
                let gradeTag = '';
                if (showGrade && s.gradeInfo) {
                    if (!s.gradeInfo.found) gradeTag = '<span class="grade-tag none">No grades</span>';
                    else if (s.gradeInfo.allPassed) gradeTag = `<span class="grade-tag passed">‚úì ${s.gradeInfo.avg}%</span>`;
                    else gradeTag = `<span class="grade-tag failed">‚ö†Ô∏è ${s.gradeInfo.failed.length} failed</span>`;
                }
                return `<div class="student-item ${hasFailed ? 'has-failed' : ''}">
                    <span class="name">${s.name || s.email.split('@')[0]}</span>
                    <span class="email">${s.email}</span>
                    <span class="level-badge level-${(s.nextLevel || s.level).replace(/\s+/g, '-')}">${s.nextLevel || s.level}</span>
                    ${gradeTag}
                    <span class="status-tag ${s.reason.includes('Return') ? 'returning' : (s.termNumber === 1 ? 'term1' : 'term2')}">${s.reason}</span>
                </div>`;
            };
            
            if (onClassList.length > 0) {
                html += `<div class="prediction-group classlist"><h4>üìö On Next Class List <span class="count">${onClassList.length}</span></h4>
                    <div class="student-list">${onClassList.map(s => renderStudent(s, true)).join('')}</div></div>`;
            }
            
            if (optionalReturn.length > 0) {
                html += `<div class="prediction-group optional"><h4>üéì BBA - Optional Continue <span class="count">${optionalReturn.length}</span></h4>
                    <p style="font-size:11px;color:#666;margin:0 0 10px;">Have degree, can continue to PGD or stop</p>
                    <div class="student-list">${optionalReturn.map(s => renderStudent(s, true)).join('')}</div></div>`;
            }
            
            if (toInternship.length > 0) {
                html += `<div class="prediction-group internship"><h4>‚úàÔ∏è To Internship <span class="count">${toInternship.length}</span></h4>
                    <div class="student-list">${toInternship.map(s => renderStudent(s, true)).join('')}</div></div>`;
            }
            
            if (graduating.length > 0) {
                html += `<div class="prediction-group graduating"><h4>üéì Graduated/Finished <span class="count">${graduating.length}</span></h4>
                    <div class="student-list">${graduating.map(s => renderStudent(s, true)).join('')}</div></div>`;
            }
            
            if (failedGrades.length > 0) {
                html += `<div class="prediction-group failed"><h4>‚ö†Ô∏è Failed Grades (<60%) <span class="count">${failedGrades.length}</span></h4>
                    <p style="font-size:11px;color:#666;margin:0 0 10px;">May need review before progressing</p>
                    <div class="student-list">${failedGrades.map(s => {
                        const fails = s.gradeInfo?.failed || [];
                        return `<div class="student-item has-failed">
                            <span class="name">${s.name || s.email.split('@')[0]}</span>
                            <span class="email">${s.email}</span>
                            <span class="level-badge level-${s.level.replace(/\s+/g, '-')}">${s.level}</span>
                            <span style="font-size:10px;color:#c5221f;">${fails.map(f => `${f.code}:${f.grade}%`).join(', ')}</span>
                        </div>`;
                    }).join('')}</div></div>`;
            }
            
            // Summary & Links
            html += `<div style="margin-top:20px;padding-top:15px;border-top:2px solid #eee;">
                <h4>üìã Summary</h4>
                <div class="stats">
                    <div class="stat">üìö Class List: ${onClassList.length}</div>
                    <div class="stat">‚Ü©Ô∏è Returning: ${returning.length}</div>
                    <div class="stat">üéì BBA Optional: ${optionalReturn.length}</div>
                    <div class="stat">‚úàÔ∏è Internship: ${toInternship.length}</div>
                    <div class="stat">üéì Graduated: ${graduating.length}</div>
                    ${failedGrades.length ? `<div class="stat" style="background:#fce8e6;">‚ö†Ô∏è Failed: ${failedGrades.length}</div>` : ''}
                </div>
                <div id="saveStatus" class="status info">‚è≥ Saving to Google Sheet...</div>
                <div id="sheetLink" style="display:none; margin-top:15px;">
                    <a href="#" id="predictionSheetLink" target="_blank" class="btn btn-purple" style="text-decoration:none;">
                        üìä Open Predictions Tab
                    </a>
                    <button class="btn btn-secondary" onclick="exportPrediction()" style="margin-left:10px;">üì• Download CSV</button>
                </div>
            </div></div>`;
            
            document.getElementById('predictionResults').innerHTML = html;
            document.getElementById('predictionResults').style.display = 'block';
            document.getElementById('predictionResults').scrollIntoView({ behavior: 'smooth' });
        }
        
        async function savePredictionToSheet(data) {
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'savePrediction',
                        term: data.term,
                        onClassList: data.onClassList,
                        optionalReturn: data.optionalReturn,
                        toInternship: data.toInternship,
                        graduating: data.graduating,
                        failedGrades: data.failedGrades
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    document.getElementById('saveStatus').className = 'status success';
                    document.getElementById('saveStatus').textContent = '‚úÖ Saved to Predictions tab!';
                    document.getElementById('sheetLink').style.display = 'block';
                    document.getElementById('predictionSheetLink').href = result.url || 'https://docs.google.com/spreadsheets/d/1omcWpajVrVMTWiOdKL5YQr40KxlRHCogJpfKuRUsdWY/edit';
                } else {
                    throw new Error(result.message || 'Unknown error');
                }
            } catch (error) {
                // Fallback - still show link to sheet
                document.getElementById('saveStatus').className = 'status warning';
                document.getElementById('saveStatus').textContent = '‚ö†Ô∏è Could not save automatically. Use CSV download.';
                document.getElementById('sheetLink').style.display = 'block';
                document.getElementById('predictionSheetLink').href = 'https://docs.google.com/spreadsheets/d/1omcWpajVrVMTWiOdKL5YQr40KxlRHCogJpfKuRUsdWY/edit';
            }
        }
        
        function exportPrediction() {
            const d = window.predictionData;
            if (!d) return;
            let csv = 'Group,Email,Name,Level,Next Level,Next Class,Status,Avg Grade,Failed Courses\n';
            const addRow = (s, group) => {
                const avg = s.gradeInfo?.avg || '';
                const failed = s.gradeInfo?.failed?.map(f => `${f.code}:${f.grade}%`).join('; ') || '';
                csv += `"${group}","${s.email}","${s.name}","${s.level}","${s.nextLevel || ''}","${s.nextClass || ''}","${s.reason}","${avg}","${failed}"\n`;
            };
            d.onClassList.forEach(s => addRow(s, 'Class List'));
            d.optionalReturn.forEach(s => addRow(s, 'BBA Optional'));
            d.toInternship.forEach(s => addRow(s, 'Internship'));
            d.graduating.forEach(s => addRow(s, 'Graduated'));
            d.failedGrades.forEach(s => addRow(s, 'Failed Grades'));
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `prediction_${d.term}.csv`;
            a.click();
        }
    </script>
</body>
</html>
