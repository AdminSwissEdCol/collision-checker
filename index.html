<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Collision Checker - Swiss Educational College</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #c8102e;
        }
        .header h1 { color: #c8102e; margin-bottom: 5px; font-size: 1.8em; }
        .header .subtitle { color: #666; font-size: 1.1em; }
        
        .step {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 5px solid #e0e0e0;
            transition: all 0.3s;
        }
        .step.active { border-left-color: #4285f4; }
        .step.complete { border-left-color: #34a853; background: #f8fff8; }
        
        .step-header { display: flex; align-items: center; margin-bottom: 15px; }
        .step-number {
            width: 36px; height: 36px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.1em;
            margin-right: 15px;
        }
        .step.active .step-number { background: #4285f4; color: white; }
        .step.complete .step-number { background: #34a853; color: white; }
        .step.complete .step-number::after { content: "‚úì"; }
        .step.complete .step-number span { display: none; }
        
        .step-title { font-size: 1.1em; font-weight: 600; color: #333; }
        .step-content { margin-left: 51px; }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            border: none;
            margin: 5px 5px 5px 0;
            transition: all 0.2s;
        }
        .btn-primary { background: #4285f4; color: white; }
        .btn-primary:hover { background: #3367d6; }
        .btn-success { background: #34a853; color: white; }
        .btn-success:hover { background: #2d8e47; }
        .btn-large { font-size: 16px; padding: 15px 30px; }
        .btn:disabled { background: #ccc !important; cursor: not-allowed; }
        .btn-secondary { background: #f1f3f4; color: #333; }
        .btn-secondary:hover { background: #e0e0e0; }
        .btn-purple { background: #7c4dff; color: white; }
        .btn-purple:hover { background: #651fff; }
        
        .upload-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #4285f4;
            background: #e8f0fe;
        }
        .upload-zone input { display: none; }
        .upload-zone .icon { font-size: 2em; margin-bottom: 10px; }
        
        .status {
            margin: 10px 0;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 14px;
        }
        .status.info { background: #e8f0fe; color: #1967d2; }
        .status.success { background: #e6f4ea; color: #137333; }
        .status.error { background: #fce8e6; color: #c5221f; }
        .status.warning { background: #fef7e0; color: #b06000; }
        .status:empty { display: none; }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .input-group input, .input-group select {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #4285f4;
        }
        
        .stats { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .stat {
            background: #f1f3f4;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .results-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-top: 20px;
        }
        .results-box h2 { margin: 0 0 10px 0; }
        .results-box a {
            display: inline-block;
            background: white;
            color: #667eea;
            padding: 12px 30px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .info-box {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 12px 15px;
            border-radius: 0 6px 6px 0;
            margin: 15px 0;
            font-size: 13px;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
        }
        
        details summary { cursor: pointer; color: #666; font-size: 13px; margin: 10px 0; }
        
        .help-section {
            margin-top: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .help-section summary {
            padding: 12px 15px;
            margin: 0;
            background: #f1f3f4;
            border-radius: 8px;
        }
        .help-section[open] summary { border-radius: 8px 8px 0 0; }
        .help-content {
            padding: 15px;
            font-size: 13px;
        }
        .help-content h4 { margin: 15px 0 8px 0; color: #333; font-size: 13px; }
        .help-content h4:first-child { margin-top: 0; }
        .help-content ul { margin: 0; padding-left: 20px; }
        .help-content li { margin: 4px 0; }
        .help-content code { background: #e8e8e8; padding: 2px 6px; border-radius: 3px; font-size: 12px; }
        
        .table-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-top: 10px;
        }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; }
        
        .level-badge {
            display: inline-block; padding: 2px 8px; border-radius: 10px;
            font-size: 10px; font-weight: 500;
        }
        .level-English { background: #e3f2fd; color: #1565c0; }
        .level-Certificate { background: #fce8e6; color: #c5221f; }
        .level-Diploma { background: #e8f0fe; color: #1967d2; }
        .level-High-Diploma { background: #fef7e0; color: #b06000; }
        .level-BBA { background: #e6f4ea; color: #137333; }
        .level-PGD { background: #f3e8fd; color: #7627bb; }
        .level-MBA { background: #fce8f4; color: #b80672; }
        .level-CUL-I, .level-CUL-II, .level-CUL-III, .level-CUL { background: #fff3e0; color: #e65100; }
        
        @media (max-width: 600px) {
            .step-content { margin-left: 0; margin-top: 15px; }
            .input-group { flex-direction: column; }
        }
        
        /* Predictor styles */
        .hidden-feature { display: none; }
        .hidden-feature.visible { display: block; }
        
        .progression-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            border: 2px solid #7c4dff;
            margin-top: 30px;
        }
        .progression-section .step-number { background: #7c4dff; color: white; }
        
        .progression-visual {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin: 10px 0;
            align-items: center;
            font-size: 11px;
        }
        .prog-step {
            text-align: center;
            padding: 6px 10px;
            border-radius: 6px;
            min-width: 60px;
        }
        .prog-arrow { color: #999; }
        
        .prediction-results {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .prediction-group {
            margin-bottom: 20px;
        }
        .prediction-group h4 {
            margin: 0 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .prediction-group h4 .count {
            background: #f1f3f4;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        .prediction-group.continuing h4 { color: #1967d2; border-color: #1967d2; }
        .prediction-group.returning h4 { color: #137333; border-color: #137333; }
        .prediction-group.internship h4 { color: #666; border-color: #999; }
        .prediction-group.graduating h4 { color: #7627bb; border-color: #7627bb; }
        .prediction-group.optional h4 { color: #b06000; border-color: #ffc107; }
        .prediction-group.failed h4 { color: #c5221f; border-color: #c5221f; }
        
        .student-list {
            max-height: 250px;
            overflow-y: auto;
            font-size: 12px;
        }
        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background: #f9f9f9;
            margin: 3px 0;
            border-radius: 4px;
            gap: 8px;
            flex-wrap: wrap;
        }
        .student-item.has-failed { background: #fce8e6; }
        .student-item.passed { background: #e6f4ea; }
        .student-item .name { font-weight: 500; min-width: 100px; }
        .student-item .email { color: #666; flex: 1; font-size: 11px; overflow: hidden; text-overflow: ellipsis; }
        .student-item .grade-info {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
        }
        .student-item .grade-info.passed { background: #e6f4ea; color: #137333; }
        .student-item .grade-info.failed { background: #fce8e6; color: #c5221f; }
        .student-item .grade-info.no-grades { background: #f1f3f4; color: #666; }
        .status-tag {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
        }
        .status-tag.term1 { background: #e8f0fe; color: #1967d2; }
        .status-tag.term2 { background: #e6f4ea; color: #137333; }
        .status-tag.returning { background: #fff3e0; color: #e65100; }
        
        .auto-detected {
            background: #e6f4ea;
            border: 1px solid #34a853;
            padding: 12px 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .auto-detected .icon { color: #34a853; margin-right: 5px; }
        
        .session-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .session-box {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        .session-box .label { font-size: 11px; color: #666; }
        .session-box .value { font-size: 18px; font-weight: bold; color: #333; }
        .session-box.highlight { background: #7c4dff; color: white; }
        .session-box.highlight .label { color: rgba(255,255,255,0.8); }
        .session-box.highlight .value { color: white; }
        
        .export-btn {
            background: #34a853;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin: 5px;
        }
        .export-btn:hover { background: #2d8e47; }
        
        .grade-details {
            width: 100%;
            margin-top: 5px;
            padding: 5px 10px;
            background: white;
            border-radius: 4px;
            font-size: 10px;
        }
        .grade-details table {
            width: 100%;
            font-size: 10px;
        }
        .grade-details td { padding: 2px 5px; border: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìö Course Collision Checker</h1>
        <p class="subtitle">Check if returning students have already taken their scheduled courses</p>
    </div>

    <!-- STEP 1-4: Original Collision Checker -->
    <div class="step active" id="step1">
        <div class="step-header">
            <div class="step-number"><span>1</span></div>
            <div class="step-title">Upload Timetable PDF</div>
        </div>
        <div class="step-content">
            <div class="upload-zone" id="uploadZone">
                <input type="file" id="pdfInput" accept=".pdf">
                <div class="icon">üìÑ</div>
                <p><strong>Drop PDF here</strong> or click to browse</p>
            </div>
            <div id="step1Status" class="status"></div>
            <div id="courseStats" class="stats"></div>
            <div id="sendCoursesSection" style="display: none; margin-top: 15px;">
                <button class="btn btn-success btn-large" onclick="sendCourses()" id="sendCoursesBtn">üì§ Send Courses</button>
            </div>
            <details id="courseDetails" style="display: none;">
                <summary>üìë View extracted courses</summary>
                <div class="table-container" id="courseTable"></div>
            </details>
        </div>
    </div>

    <div class="step" id="step2">
        <div class="step-header">
            <div class="step-number"><span>2</span></div>
            <div class="step-title">Import Class List</div>
        </div>
        <div class="step-content">
            <div class="input-group">
                <input type="text" id="studentsUrl" placeholder="Google Sheet URL">
                <button class="btn btn-primary" onclick="importStudents()" id="importStudentsBtn">üì• Import</button>
            </div>
            <div id="step2Status" class="status"></div>
        </div>
    </div>

    <div class="step" id="step3">
        <div class="step-header">
            <div class="step-number"><span>3</span></div>
            <div class="step-title">Update Historical Grade Data</div>
        </div>
        <div class="step-content">
            <button class="btn btn-primary" onclick="updateRaw()" id="updateRawBtn">üîÑ Update Raw Data</button>
            <button class="btn btn-secondary" onclick="skipStep3()">Skip ‚Üí</button>
            <div id="step3Status" class="status"></div>
        </div>
    </div>

    <div class="step" id="step4">
        <div class="step-header">
            <div class="step-number"><span>4</span></div>
            <div class="step-title">Check for Collisions</div>
        </div>
        <div class="step-content">
            <button class="btn btn-success btn-large" onclick="checkCollisions()" id="checkBtn">üîç Check for Collisions</button>
            <div id="step4Status" class="status"></div>
        </div>
    </div>

    <div id="resultsSection" style="display: none;"></div>

    <!-- Toggle for Predictor -->
    <div style="text-align: center; margin: 20px 0;">
        <button class="btn btn-secondary" onclick="toggleProgressionPredictor()" id="predictorToggle" style="opacity: 0.6;">
            üîÆ Predict Next Term Class List
        </button>
    </div>

    <!-- PROGRESSION PREDICTOR -->
    <div class="step progression-section hidden-feature" id="progressionSection">
        <div class="step-header">
            <div class="step-number"><span>üîÆ</span></div>
            <div class="step-title">Student Progression Predictor</div>
        </div>
        <div class="step-content">
            <p>Load the Master Class List and Raw Grades to predict who will be on the next term's class list with grade verification.</p>
            
            <details class="help-section">
                <summary>üìã Progression Rules</summary>
                <div class="help-content">
                    <h4>Business Track:</h4>
                    <div class="progression-visual">
                        <div class="prog-step level-English">English (1)</div>
                        <div class="prog-arrow">‚Üí</div>
                        <div class="prog-step level-Certificate">Cert (2)</div>
                        <div class="prog-arrow">‚Üíüì¶‚Üí</div>
                        <div class="prog-step level-Diploma">Dip (2)</div>
                        <div class="prog-arrow">‚Üíüì¶‚Üí</div>
                        <div class="prog-step level-High-Diploma">HD (2)</div>
                        <div class="prog-arrow">‚Üíüì¶‚Üí</div>
                        <div class="prog-step level-BBA">BBA üéì</div>
                        <div class="prog-arrow">‚Üíüì¶‚Üí</div>
                        <div class="prog-step level-PGD">PGD (2)</div>
                        <div class="prog-arrow">‚Üíüì¶‚Üí</div>
                        <div class="prog-step level-MBA">MBA üéì</div>
                    </div>
                    <h4>Culinary Track:</h4>
                    <div class="progression-visual">
                        <div class="prog-step level-CUL-I">CUL I (2)</div>
                        <div class="prog-arrow">‚Üíüì¶‚Üí</div>
                        <div class="prog-step level-CUL-II">CUL II (2)</div>
                        <div class="prog-arrow">‚Üíüì¶‚Üí</div>
                        <div class="prog-step level-CUL-III">CUL III</div>
                    </div>
                    <p style="font-size: 11px; color: #666;">üì¶ = 2 terms internship | üéì = Degree | Pass = ‚â•60%</p>
                </div>
            </details>

            <!-- Step A: Load Master List -->
            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 8px;">
                <h4 style="margin-top: 0;">üì• Step A: Load Master Class List</h4>
                <div class="input-group">
                    <input type="text" id="masterListUrl" placeholder="Master Class List URL" value="https://docs.google.com/spreadsheets/d/1Kv7GIyEYbYfKciun1bQBoMD59gEjDLPZ_ovQpJU9kTQ/edit">
                    <button class="btn btn-purple" onclick="loadMasterList()" id="loadMasterBtn">Load</button>
                </div>
                <div id="masterLoadStatus" class="status"></div>
            </div>
            
            <!-- Step B: Load Raw Grades -->
            <div id="rawGradesSection" style="display: none; margin: 20px 0; padding: 15px; background: white; border-radius: 8px;">
                <h4 style="margin-top: 0;">üìä Step B: Load Raw Grades Data</h4>
                <p style="font-size: 12px; color: #666; margin: 5px 0 10px;">Load the raw grades to verify if returning students passed their previous level (‚â•60%).</p>
                <div class="input-group">
                    <input type="text" id="rawGradesUrl" placeholder="Raw Grades Sheet URL (same as collision checker)" value="https://docs.google.com/spreadsheets/d/1omcWpajVrVMTWiOdKL5YQr40KxlRHCogJpfKuRUsdWY/edit#gid=0">
                    <button class="btn btn-primary" onclick="loadRawGrades()" id="loadRawBtn">Load Grades</button>
                </div>
                <div id="rawLoadStatus" class="status"></div>
            </div>

            <!-- Session Info Display -->
            <div id="masterLoadedSection" style="display: none;">
                <div class="auto-detected">
                    <span class="icon">‚úì</span> <strong>Data Loaded</strong>
                    <div class="session-info">
                        <div class="session-box">
                            <div class="label">Current Session</div>
                            <div class="value" id="currentSessionDisplay">--</div>
                        </div>
                        <div class="session-box">
                            <div class="label">Students Now</div>
                            <div class="value" id="currentCountDisplay">--</div>
                        </div>
                        <div class="session-box highlight">
                            <div class="label">Predicting For</div>
                            <div class="value" id="nextSessionDisplay">--</div>
                        </div>
                        <div class="session-box">
                            <div class="label">Returning From</div>
                            <div class="value" id="returnSessionDisplay">--</div>
                        </div>
                        <div class="session-box">
                            <div class="label">Raw Grades</div>
                            <div class="value" id="rawGradesCountDisplay">--</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-purple btn-large" onclick="generatePrediction()">
                        üîÆ Generate Prediction with Grade Check
                    </button>
                </div>
            </div>

            <div id="predictionResults" style="display: none;"></div>
        </div>
    </div>

    <div class="footer">
        Swiss Educational College ‚Ä¢ Course Collision Checker
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzD-Fsbe8g4eXlwIE-VYpOFIxCftbchaxyYXafgWRfn7nzLz3n7feLo6G8zXqx14eb2/exec';
        
        // ========== PROGRESSION STATE ==========
        const BUSINESS_TRACK = ['English', 'Certificate', 'Diploma', 'High Diploma', 'BBA', 'PGD', 'MBA'];
        const CULINARY_TRACK = ['CUL I', 'CUL II', 'CUL III', 'CUL'];
        const LEVEL_TERMS = { 'English': 1, 'Certificate': 2, 'Diploma': 2, 'High Diploma': 2, 'BBA': 2, 'PGD': 2, 'MBA': 2, 'CUL I': 2, 'CUL II': 2, 'CUL III': 2, 'CUL': 2 };
        const FINAL_LEVELS = ['MBA', 'CUL III'];
        const OPTIONAL_CONTINUE = ['BBA'];
        const PASS_THRESHOLD = 60;
        
        let masterData = {};  // {session: [{student}]}
        let allSessions = [];
        let currentSession = null;
        let rawGrades = {};   // {email: {session: {courseCode: totalGrade}}}
        let rawGradesLoaded = false;

        function toggleProgressionPredictor() {
            const section = document.getElementById('progressionSection');
            const btn = document.getElementById('predictorToggle');
            if (section.classList.contains('visible')) {
                section.classList.remove('visible');
                btn.textContent = 'üîÆ Predict Next Term Class List';
                btn.style.opacity = '0.6';
            } else {
                section.classList.add('visible');
                btn.textContent = 'üîÆ Hide Prediction Tool';
                btn.style.opacity = '1';
                section.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function parseSession(str) {
            const m = str?.match(/(\d{2})-T(\d)/);
            return m ? { year: parseInt(m[1]), term: parseInt(m[2]), str: str } : null;
        }

        function parseClass(str) {
            const m = str?.match(/(\d{2})-T(\d)-Class-(.+)/i);
            return m ? { year: parseInt(m[1]), term: parseInt(m[2]), level: m[3].trim() } : null;
        }

        function sessionToNum(s) { return s.year * 4 + s.term; }
        function formatSession(year, term) { return `${year}-T${term}`; }

        function getNextSession(session) {
            let y = session.year, t = session.term + 1;
            if (t > 4) { t = 1; y++; }
            return { year: y, term: t, str: formatSession(y, t) };
        }

        function getPrevSession(session, count = 1) {
            let y = session.year, t = session.term;
            for (let i = 0; i < count; i++) {
                t--;
                if (t < 1) { t = 4; y--; }
            }
            return { year: y, term: t, str: formatSession(y, t) };
        }

        function getNextLevel(level) {
            let track = BUSINESS_TRACK;
            if (CULINARY_TRACK.some(l => level.toUpperCase().includes(l.replace(' ', '').toUpperCase()))) {
                track = CULINARY_TRACK;
            }
            const idx = track.findIndex(l => l.toUpperCase() === level.toUpperCase());
            return (idx >= 0 && idx < track.length - 1) ? track[idx + 1] : null;
        }

        function normalizeLevel(level) {
            if (/^CUL\s*I$/i.test(level)) return 'CUL I';
            if (/^CUL\s*II$/i.test(level)) return 'CUL II';
            if (/^CUL\s*III$/i.test(level)) return 'CUL III';
            if (/^CUL$/i.test(level)) return 'CUL';
            return level;
        }

        // Get student's grades for specific sessions (same logic as collision checker)
        // sessions: array of session strings like ["24-T3", "24-T4"]
        function getStudentGrades(email, sessions) {
            const emailLower = email.toLowerCase();
            const studentGrades = rawGrades[emailLower];
            
            if (!studentGrades) {
                return { found: false, courses: [], avgGrade: null, failedCourses: [], passedCourses: [], totalCourses: 0 };
            }
            
            const courses = [];
            const failedCourses = [];
            const passedCourses = [];
            let totalGradeSum = 0;
            let courseCount = 0;
            
            // Check each requested session
            for (const sessionStr of sessions) {
                const sessionGrades = studentGrades[sessionStr];
                if (!sessionGrades) continue;
                
                // For each course in this session
                for (const [courseCode, gradeData] of Object.entries(sessionGrades)) {
                    // Total grade is already summed (SUM of all contribution % for this course)
                    const totalGrade = Math.round(gradeData.total * 10) / 10;
                    const courseName = courseNames[courseCode] || courseCode;
                    
                    courses.push({ 
                        session: sessionStr, 
                        course: courseCode, 
                        courseName: courseName,
                        grade: totalGrade 
                    });
                    
                    totalGradeSum += totalGrade;
                    courseCount++;
                    
                    if (totalGrade < PASS_THRESHOLD) {
                        failedCourses.push({ 
                            course: courseCode, 
                            courseName: courseName,
                            grade: totalGrade, 
                            session: sessionStr 
                        });
                    } else {
                        passedCourses.push({ 
                            course: courseCode, 
                            courseName: courseName,
                            grade: totalGrade, 
                            session: sessionStr 
                        });
                    }
                }
            }
            
            return {
                found: courseCount > 0,
                courses: courses,
                avgGrade: courseCount > 0 ? Math.round(totalGradeSum / courseCount) : null,
                failedCourses: failedCourses,
                passedCourses: passedCourses,
                totalCourses: courseCount,
                allPassed: failedCourses.length === 0 && courseCount > 0
            };
        }

        async function loadMasterList() {
            const url = document.getElementById('masterListUrl').value.trim();
            if (!url) {
                setStatus('masterLoadStatus', 'error', '‚ö†Ô∏è Please paste a URL');
                return;
            }
            
            const btn = document.getElementById('loadMasterBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥...';
            setStatus('masterLoadStatus', 'info', '‚è≥ Loading master list...');
            
            try {
                const idMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
                if (!idMatch) throw new Error('Invalid Google Sheets URL');
                
                const csvUrl = `https://docs.google.com/spreadsheets/d/${idMatch[1]}/export?format=csv`;
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error('Cannot access sheet. Make sure it is shared.');
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                if (rows.length < 2) throw new Error('Sheet is empty');
                
                const headers = rows[0].map(h => h.toLowerCase().trim());
                const sessionIdx = headers.indexOf('session');
                const classIdx = headers.findIndex(h => h === 'class');
                const emailIdx = headers.findIndex(h => h.includes('school email') || (h.includes('email') && !h.includes('recovery')));
                const firstNameIdx = headers.findIndex(h => h.includes('first name'));
                const callNameIdx = headers.findIndex(h => h.includes('call name'));
                
                if (sessionIdx < 0 || classIdx < 0 || emailIdx < 0) {
                    throw new Error('Missing required columns: Session, Class, Email');
                }
                
                masterData = {};
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    const sessionStr = row[sessionIdx]?.trim();
                    const classStr = row[classIdx]?.trim();
                    const email = row[emailIdx]?.trim();
                    
                    if (!sessionStr || !classStr || !email) continue;
                    
                    const session = parseSession(sessionStr);
                    const classInfo = parseClass(classStr);
                    
                    if (!session || !classInfo) continue;
                    
                    if (!masterData[sessionStr]) masterData[sessionStr] = [];
                    
                    const termNum = sessionToNum(session) - sessionToNum({year: classInfo.year, term: classInfo.term}) + 1;
                    
                    let name = '';
                    if (callNameIdx >= 0 && row[callNameIdx]) name = row[callNameIdx].trim();
                    else if (firstNameIdx >= 0) name = (row[firstNameIdx] || '').trim();
                    
                    masterData[sessionStr].push({
                        email: email.toLowerCase(),
                        name: name,
                        sessionStr: sessionStr,
                        classStr: classStr,
                        level: normalizeLevel(classInfo.level),
                        classYear: classInfo.year,
                        classTerm: classInfo.term,
                        termNumber: termNum
                    });
                }
                
                allSessions = Object.keys(masterData).sort((a, b) => {
                    const sa = parseSession(a), sb = parseSession(b);
                    return sessionToNum(sa) - sessionToNum(sb);
                });
                
                if (allSessions.length === 0) throw new Error('No valid session data found');
                
                const latestSessionStr = allSessions[allSessions.length - 1];
                currentSession = parseSession(latestSessionStr);
                const nextSession = getNextSession(currentSession);
                const returnFromSession = getPrevSession(currentSession, 2);
                
                document.getElementById('currentSessionDisplay').textContent = latestSessionStr;
                document.getElementById('currentCountDisplay').textContent = masterData[latestSessionStr].length;
                document.getElementById('nextSessionDisplay').textContent = nextSession.str;
                document.getElementById('returnSessionDisplay').textContent = returnFromSession.str;
                
                document.getElementById('rawGradesSection').style.display = 'block';
                setStatus('masterLoadStatus', 'success', `‚úÖ Loaded ${rows.length - 1} records across ${allSessions.length} sessions`);
                
            } catch (error) {
                setStatus('masterLoadStatus', 'error', '‚ùå ' + error.message);
            }
            
            btn.disabled = false;
            btn.textContent = 'Load';
        }

        async function loadRawGrades() {
            const url = document.getElementById('rawGradesUrl').value.trim();
            if (!url) {
                setStatus('rawLoadStatus', 'error', '‚ö†Ô∏è Please paste a URL');
                return;
            }
            
            const btn = document.getElementById('loadRawBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥...';
            setStatus('rawLoadStatus', 'info', '‚è≥ Loading raw grades (this may take a moment for large files)...');
            
            try {
                const idMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
                if (!idMatch) throw new Error('Invalid URL');
                
                // Try to get the 'raw' sheet specifically using gviz endpoint
                let csvUrl = `https://docs.google.com/spreadsheets/d/${idMatch[1]}/gviz/tq?tqx=out:csv&sheet=raw`;
                let response = await fetch(csvUrl);
                
                if (!response.ok) {
                    // Fallback to export with gid for raw sheet (gid=0 is usually first sheet)
                    csvUrl = `https://docs.google.com/spreadsheets/d/${idMatch[1]}/export?format=csv&gid=0`;
                    response = await fetch(csvUrl);
                }
                
                if (!response.ok) throw new Error('Cannot access sheet. Make sure it is shared.');
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                if (rows.length < 2) throw new Error('No data found in raw sheet');
                
                const headers = rows[0].map(h => h.toLowerCase().trim());
                
                // Find columns - same logic as collision checker GS code
                const emailIdx = headers.findIndex(h => h.includes('email'));
                const sessionIdx = headers.findIndex(h => h === 'session');
                const courseCodeIdx = headers.findIndex(h => h === 'course code' || h === 'coursecode' || h.includes('course code'));
                const contributionIdx = headers.findIndex(h => h === 'contribution %' || h === 'contribution%' || h.includes('contribution'));
                const courseNameIdx = headers.findIndex(h => h === 'course' || (h.includes('course') && !h.includes('code')));
                
                if (emailIdx < 0) throw new Error('No "Email" column found in raw sheet');
                if (courseCodeIdx < 0) throw new Error('No "Course Code" column found');
                if (contributionIdx < 0) throw new Error('No "Contribution %" column found. Run "Update Raw Data" in the collision checker first.');
                
                // Parse grades: {email: {session: {courseCode: {total: number, courseName: string}}}}
                rawGrades = {};
                courseNames = {};
                let gradeCount = 0;
                
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    const email = (row[emailIdx] || '').trim().toLowerCase();
                    const session = (row[sessionIdx] || '').trim();
                    const courseCode = (row[courseCodeIdx] || '').trim().toUpperCase();
                    const contributionStr = (row[contributionIdx] || '').toString().trim();
                    const courseName = courseNameIdx >= 0 ? (row[courseNameIdx] || '').trim() : '';
                    
                    if (!email || !courseCode) continue;
                    
                    // Store course name
                    if (courseName && !courseNames[courseCode]) {
                        // Extract name from "Course Name (CODE)" format if needed
                        const nameMatch = courseName.match(/^(.+?)\s*\(C?\d{4}[A-Z]\)$/);
                        courseNames[courseCode] = nameMatch ? nameMatch[1].trim() : courseName;
                    }
                    
                    // Parse contribution (handle "50%", "50", empty, etc)
                    if (contributionStr === '' || contributionStr === null) continue;
                    const contribution = parseFloat(contributionStr.replace('%', '').replace(',', '.'));
                    if (isNaN(contribution)) continue;
                    
                    // Initialize nested structure
                    if (!rawGrades[email]) rawGrades[email] = {};
                    if (!rawGrades[email][session]) rawGrades[email][session] = {};
                    if (!rawGrades[email][session][courseCode]) {
                        rawGrades[email][session][courseCode] = { total: 0, contributions: [] };
                    }
                    
                    // SUM contributions (same as collision checker)
                    rawGrades[email][session][courseCode].total += contribution;
                    rawGrades[email][session][courseCode].contributions.push(contribution);
                    gradeCount++;
                }
                
                rawGradesLoaded = true;
                document.getElementById('rawGradesCountDisplay').textContent = Object.keys(rawGrades).length;
                document.getElementById('masterLoadedSection').style.display = 'block';
                
                setStatus('rawLoadStatus', 'success', `‚úÖ Loaded ${gradeCount} grade entries for ${Object.keys(rawGrades).length} students`);
                
            } catch (error) {
                setStatus('rawLoadStatus', 'error', '‚ùå ' + error.message);
                // Still allow prediction without grades
                document.getElementById('masterLoadedSection').style.display = 'block';
                document.getElementById('rawGradesCountDisplay').textContent = '0';
            }
            
            btn.disabled = false;
            btn.textContent = 'Load Grades';
        }
        
        let courseNames = {};

        function generatePrediction() {
            if (!currentSession || Object.keys(masterData).length === 0) {
                alert('Please load the master list first');
                return;
            }
            
            const nextSession = getNextSession(currentSession);
            const returnFromSession = getPrevSession(currentSession, 2);
            
            const currentStudents = masterData[formatSession(currentSession.year, currentSession.term)] || [];
            const twoTermsAgoStudents = masterData[returnFromSession.str] || [];
            
            const continuing = [];
            const toInternship = [];
            const graduating = [];
            const optionalReturn = [];
            const returning = [];
            const failedGrades = [];
            
            // Helper to get the two sessions when a student was studying at their level
            // If they started in 24-T3, they studied in 24-T3 (Term 1) and 24-T4 (Term 2)
            function getStudySessions(classYear, classTerm) {
                const term1 = formatSession(classYear, classTerm);
                const term2Session = getNextSession({ year: classYear, term: classTerm });
                const term2 = term2Session.str;
                return [term1, term2];
            }
            
            // Process current students
            const currentEmails = new Set();
            for (const s of currentStudents) {
                currentEmails.add(s.email);
                
                if (s.level === 'English') {
                    // English is 1 term, no grade check needed for progression
                    continuing.push({...s, nextLevel: 'Certificate', nextClass: `${nextSession.year}-T${nextSession.term}-Class-Certificate`, reason: 'English ‚Üí Certificate', gradeInfo: null});
                } else if (s.termNumber === 1) {
                    // Term 1 students continue to Term 2, no grade check yet
                    continuing.push({...s, nextLevel: s.level, nextClass: `${nextSession.year}-T${nextSession.term}-Class-${s.level}`, reason: 'Term 1 ‚Üí Term 2', gradeInfo: null});
                } else {
                    // Term 2 - finishing current level, check their grades for this level
                    // They studied in their classYear-classTerm (T1) and the next term (T2)
                    const studySessions = getStudySessions(s.classYear, s.classTerm);
                    const gradeInfo = rawGradesLoaded ? getStudentGrades(s.email, studySessions) : null;
                    
                    if (FINAL_LEVELS.includes(s.level)) {
                        graduating.push({...s, reason: `Completed ${s.level} üéì`, gradeInfo, studySessions});
                    } else if (OPTIONAL_CONTINUE.includes(s.level)) {
                        const next = getNextLevel(s.level);
                        optionalReturn.push({...s, nextLevel: next, reason: 'BBA Degree - Optional to continue', gradeInfo, studySessions});
                    } else {
                        const next = getNextLevel(s.level);
                        toInternship.push({...s, nextLevel: next, reason: `‚Üí Internship ‚Üí ${next || 'Done'}`, gradeInfo, studySessions});
                        
                        // Flag if failed grades
                        if (gradeInfo && !gradeInfo.allPassed && gradeInfo.found) {
                            failedGrades.push({...s, gradeInfo, studySessions, note: `Failed courses in ${s.level}`});
                        }
                    }
                }
            }
            
            // Find returning students from 2 terms ago (were in Term 2, now returning from internship)
            for (const s of twoTermsAgoStudents) {
                if (currentEmails.has(s.email)) continue;
                
                if (s.termNumber >= 2 && !FINAL_LEVELS.includes(s.level) && !OPTIONAL_CONTINUE.includes(s.level)) {
                    const nextLevel = getNextLevel(s.level);
                    if (nextLevel) {
                        // Check their grades from when they were studying (2 terms ago)
                        // They studied in classYear-classTerm (T1) and the next term (T2)
                        const studySessions = getStudySessions(s.classYear, s.classTerm);
                        const gradeInfo = rawGradesLoaded ? getStudentGrades(s.email, studySessions) : null;
                        
                        returning.push({
                            ...s,
                            nextLevel: nextLevel,
                            nextClass: `${nextSession.year}-T${nextSession.term}-Class-${nextLevel}`,
                            reason: `Returning ‚Üí ${nextLevel}`,
                            gradeInfo: gradeInfo,
                            studySessions: studySessions
                        });
                        
                        // Flag if failed
                        if (gradeInfo && !gradeInfo.allPassed && gradeInfo.found) {
                            failedGrades.push({...s, gradeInfo, studySessions, note: `Failed courses in ${s.level}`});
                        }
                    }
                }
            }
            
            // Build HTML
            let html = `<div class="prediction-results">
                <h3 style="margin-top:0;">üìä Predicted Class List for ${nextSession.str}</h3>
                ${rawGradesLoaded ? '<p style="font-size:12px;color:#137333;">‚úì Grade data loaded - checking pass/fail status (‚â•60% = pass)</p>' : '<p style="font-size:12px;color:#b06000;">‚ö†Ô∏è No grade data loaded - progression shown without grade verification</p>'}`;
            
            // Helper to render grade info badge
            const renderGradeInfo = (gradeInfo, studySessions) => {
                if (!gradeInfo || !gradeInfo.found) {
                    return `<span class="grade-info no-grades" title="No grades found for sessions: ${studySessions?.join(', ') || 'N/A'}">No grades</span>`;
                }
                if (gradeInfo.allPassed) {
                    return `<span class="grade-info passed" title="${gradeInfo.totalCourses} courses, avg ${gradeInfo.avgGrade}%">‚úì ${gradeInfo.totalCourses} courses passed</span>`;
                }
                return `<span class="grade-info failed" title="${gradeInfo.failedCourses.length} of ${gradeInfo.totalCourses} courses below 60%">‚ö†Ô∏è ${gradeInfo.failedCourses.length} failed</span>`;
            };
            
            // Helper to render detailed failed courses
            const renderFailedDetails = (gradeInfo) => {
                if (!gradeInfo || !gradeInfo.failedCourses || gradeInfo.failedCourses.length === 0) return '';
                return `<div class="grade-details">
                    <strong>Failed (<60%):</strong> 
                    ${gradeInfo.failedCourses.map(c => `<span style="margin-right:8px;color:#c5221f;">${c.course} (${c.grade}%)</span>`).join('')}
                </div>`;
            };
            
            const renderStudentItem = (s, showGrades = false) => {
                const hasFailed = s.gradeInfo && !s.gradeInfo.allPassed && s.gradeInfo.found;
                let itemClass = hasFailed ? 'student-item has-failed' : (s.gradeInfo?.allPassed ? 'student-item passed' : 'student-item');
                
                return `<div class="${itemClass}">
                    <span class="name">${s.name || s.email.split('@')[0]}</span>
                    <span class="email">${s.email}</span>
                    <span class="level-badge level-${(s.nextLevel || s.level).replace(/\s+/g, '-')}">${s.nextLevel || s.level}</span>
                    ${showGrades && rawGradesLoaded ? renderGradeInfo(s.gradeInfo, s.studySessions) : ''}
                    <span class="status-tag ${s.reason.includes('Returning') ? 'returning' : (s.termNumber === 1 ? 'term1' : 'term2')}">${s.reason}</span>
                    ${showGrades && hasFailed ? renderFailedDetails(s.gradeInfo) : ''}
                </div>`;
            };
            
            // On class list
            const onClassList = [...continuing, ...returning];
            if (onClassList.length > 0) {
                html += `<div class="prediction-group continuing">
                    <h4>üìö On Next Class List <span class="count">${onClassList.length}</span></h4>
                    <div class="student-list">
                        ${onClassList.map(s => renderStudentItem(s, true)).join('')}
                    </div>
                </div>`;
            }
            
            // BBA optional
            if (optionalReturn.length > 0) {
                html += `<div class="prediction-group optional">
                    <h4>üéì BBA Graduates - Optional Return <span class="count">${optionalReturn.length}</span></h4>
                    <p style="font-size:11px;color:#666;margin:0 0 10px;">May continue to PGD or stop (have degree)</p>
                    <div class="student-list">
                        ${optionalReturn.map(s => renderStudentItem(s, true)).join('')}
                    </div>
                </div>`;
            }
            
            // To internship
            if (toInternship.length > 0) {
                html += `<div class="prediction-group internship">
                    <h4>‚úàÔ∏è Going to Internship <span class="count">${toInternship.length}</span></h4>
                    <div class="student-list">
                        ${toInternship.map(s => renderStudentItem(s, true)).join('')}
                    </div>
                </div>`;
            }
            
            // Graduating
            if (graduating.length > 0) {
                html += `<div class="prediction-group graduating">
                    <h4>üéì Graduating / Finished <span class="count">${graduating.length}</span></h4>
                    <div class="student-list">
                        ${graduating.map(s => renderStudentItem(s, true)).join('')}
                    </div>
                </div>`;
            }
            
            // Failed grades warning
            if (failedGrades.length > 0) {
                html += `<div class="prediction-group failed">
                    <h4>‚ö†Ô∏è Students with Failed Grades (<60%) <span class="count">${failedGrades.length}</span></h4>
                    <p style="font-size:11px;color:#666;margin:0 0 10px;">These students have courses below 60% in their level and may need academic review before progressing.</p>
                    <div class="student-list">
                        ${failedGrades.map(s => {
                            const courses = s.gradeInfo?.failedCourses || [];
                            return `<div class="student-item has-failed">
                                <span class="name">${s.name || s.email.split('@')[0]}</span>
                                <span class="email">${s.email}</span>
                                <span class="level-badge level-${s.level.replace(/\s+/g, '-')}">${s.level}</span>
                                <span style="font-size:10px;color:#666;">Sessions: ${s.studySessions?.join(', ') || 'N/A'}</span>
                                <div class="grade-details" style="width:100%;">
                                    <strong>Failed courses:</strong>
                                    ${courses.map(c => `<span style="margin-right:10px;">${c.course}: <strong style="color:#c5221f;">${c.grade}%</strong> (${c.session})</span>`).join('')}
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
            }
            
            // Summary
            const passedCount = returning.filter(s => s.gradeInfo?.allPassed).length;
            const noGradeCount = returning.filter(s => !s.gradeInfo?.found).length;
            
            html += `<div style="margin-top:20px;padding-top:15px;border-top:2px solid #eee;">
                <h4 style="margin-top:0;">üìã Summary</h4>
                <div class="stats">
                    <div class="stat"><strong>üìö On Class List:</strong> ${onClassList.length}</div>
                    <div class="stat"><strong>‚Ü©Ô∏è Returning:</strong> ${returning.length} ${rawGradesLoaded ? `(${passedCount} passed, ${noGradeCount} no grades)` : ''}</div>
                    <div class="stat"><strong>üéì BBA Optional:</strong> ${optionalReturn.length}</div>
                    <div class="stat"><strong>‚úàÔ∏è To Internship:</strong> ${toInternship.length}</div>
                    <div class="stat"><strong>üéì Graduating:</strong> ${graduating.length}</div>
                    ${failedGrades.length ? `<div class="stat" style="background:#fce8e6;"><strong>‚ö†Ô∏è Failed Grades:</strong> ${failedGrades.length}</div>` : ''}
                </div>
                <button class="export-btn" onclick="exportPrediction('classlist')">üì• Export Class List</button>
                <button class="export-btn" onclick="exportPrediction('all')" style="background:#666;">üì• Export All</button>
                <button class="export-btn" onclick="exportPrediction('failed')" style="background:#c5221f;">üì• Export Failed</button>
            </div></div>`;
            
            window.predictionData = { term: nextSession.str, onClassList, optionalReturn, toInternship, graduating, failedGrades, returning };
            
            document.getElementById('predictionResults').innerHTML = html;
            document.getElementById('predictionResults').style.display = 'block';
            document.getElementById('predictionResults').scrollIntoView({ behavior: 'smooth' });
        }

        function exportPrediction(type) {
            const d = window.predictionData;
            if (!d) return;
            
            let csv = 'Email,Name,Current Level,Next Level,Next Class,Status,Study Sessions,Total Courses,Avg Grade,Failed Courses\n';
            
            const addRow = (s, group) => {
                const studySessions = s.studySessions?.join('; ') || '';
                const totalCourses = s.gradeInfo?.totalCourses || '';
                const avgGrade = s.gradeInfo?.avgGrade || '';
                const failed = s.gradeInfo?.failedCourses?.map(c => `${c.course}:${c.grade}%`).join('; ') || '';
                csv += `"${s.email}","${s.name}","${s.level}","${s.nextLevel || ''}","${s.nextClass || ''}","${group}","${studySessions}","${totalCourses}","${avgGrade}","${failed}"\n`;
            };
            
            if (type === 'classlist' || type === 'all') {
                for (const s of d.onClassList) addRow(s, 'Class List');
            }
            if (type === 'all') {
                for (const s of d.optionalReturn) addRow(s, 'BBA Optional');
                for (const s of d.toInternship) addRow(s, 'Internship');
                for (const s of d.graduating) addRow(s, 'Graduated');
            }
            if (type === 'failed') {
                for (const s of d.failedGrades) addRow(s, 'Failed Grades');
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `prediction_${d.term}_${type}.csv`;
            a.click();
        }

        function parseCSV(text) {
            const rows = [];
            let row = [], cell = '', inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const c = text[i], n = text[i + 1];
                if (inQuotes) {
                    if (c === '"' && n === '"') { cell += '"'; i++; }
                    else if (c === '"') inQuotes = false;
                    else cell += c;
                } else {
                    if (c === '"') inQuotes = true;
                    else if (c === ',') { row.push(cell); cell = ''; }
                    else if (c === '\n' || (c === '\r' && n === '\n')) { row.push(cell); rows.push(row); row = []; cell = ''; if (c === '\r') i++; }
                    else if (c !== '\r') cell += c;
                }
            }
            if (cell || row.length) { row.push(cell); rows.push(row); }
            return rows;
        }

        // ========== COLLISION CHECKER (Original) ==========
        let extractedCourses = [], pdfFileName = '', validCourseCodes = new Set();
        const COURSE_CODE_PATTERN = /\(?(C?)(\d{4})\s*\(?([A-Z])\)?\)?/g;

        async function fetchValidCourseCodes() {
            try {
                const r = await fetch(`${WEB_APP_URL}?action=getCourseCodes`);
                if (r.ok) {
                    const d = await r.json();
                    if (d.codes) validCourseCodes = new Set(d.codes.map(c => c.toUpperCase()));
                }
            } catch (e) {}
        }

        function detectLevel(t) {
            const h = t.substring(0, 200).toUpperCase();
            if (h.includes('CUL III')) return 'CUL III';
            if (h.includes('CUL II')) return 'CUL II';
            if (h.includes('CUL I')) return 'CUL I';
            if (h.includes('HIGH DIPLOMA')) return 'High Diploma';
            if (h.includes('DIPLOMA')) return 'Diploma';
            if (h.includes('CERTIFICATE')) return 'Certificate';
            if (h.includes('MBA')) return 'MBA';
            if (h.includes('BBA')) return 'BBA';
            if (h.includes('PGD')) return 'PGD';
            if (h.includes('ENGLISH')) return 'English';
            return 'Unknown';
        }

        async function parsePDF(file) {
            setStatus('step1Status', 'info', '‚è≥ Processing...');
            pdfFileName = file.name;
            try {
                const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
                const courses = new Map();
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const text = (await page.getTextContent()).items.map(x => x.str).join(' ');
                    const level = detectLevel(text);
                    COURSE_CODE_PATTERN.lastIndex = 0;
                    let m;
                    while ((m = COURSE_CODE_PATTERN.exec(text)) !== null) {
                        const code = (m[1] || '') + m[2] + m[3].toUpperCase();
                        if (validCourseCodes.size === 0 || validCourseCodes.has(code) || validCourseCodes.has(code.replace(/^C/, ''))) {
                            if (!courses.has(code)) courses.set(code, new Set());
                            if (level !== 'Unknown') courses.get(code).add(level);
                        }
                    }
                }
                extractedCourses = [];
                courses.forEach((levels, code) => {
                    (levels.size ? [...levels] : ['Unknown']).forEach(l => extractedCourses.push({ code, level: l }));
                });
                extractedCourses.sort((a, b) => a.level.localeCompare(b.level) || a.code.localeCompare(b.code));
                document.getElementById('courseStats').innerHTML = `<div class="stat">${extractedCourses.length} courses</div>`;
                document.getElementById('sendCoursesSection').style.display = 'block';
                document.getElementById('courseDetails').style.display = 'block';
                document.getElementById('courseTable').innerHTML = '<table><tr><th>Code</th><th>Level</th></tr>' + extractedCourses.map(c => `<tr><td>${c.code}</td><td><span class="level-badge level-${c.level.replace(/\s+/g,'-')}">${c.level}</span></td></tr>`).join('') + '</table>';
                setStatus('step1Status', 'success', `‚úÖ ${extractedCourses.length} courses`);
            } catch (e) {
                setStatus('step1Status', 'error', '‚ùå ' + e.message);
            }
        }

        async function sendCourses() {
            const btn = document.getElementById('sendCoursesBtn');
            btn.disabled = true;
            await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'importCourses', courses: extractedCourses, pdfName: pdfFileName }) });
            setStatus('step1Status', 'success', '‚úÖ Sent!');
            completeStep('step1'); activateStep('step2');
            btn.textContent = '‚úÖ Sent!';
        }

        async function importStudents() {
            const url = document.getElementById('studentsUrl').value.trim();
            if (!url) { setStatus('step2Status', 'error', '‚ö†Ô∏è Paste URL'); return; }
            const btn = document.getElementById('importStudentsBtn');
            btn.disabled = true; btn.textContent = '‚è≥...';
            setStatus('step2Status', 'info', '‚è≥ Importing...');
            await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'importStudents', url }) });
            await new Promise(r => setTimeout(r, 3000));
            setStatus('step2Status', 'success', '‚úÖ Done!');
            completeStep('step2'); activateStep('step3');
            btn.disabled = false; btn.textContent = 'üì• Import';
        }

        async function updateRaw() {
            const btn = document.getElementById('updateRawBtn');
            btn.disabled = true; btn.textContent = '‚è≥...';
            setStatus('step3Status', 'info', '‚è≥ Updating...');
            await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateRaw' }) });
            await new Promise(r => setTimeout(r, 5000));
            setStatus('step3Status', 'success', '‚úÖ Done!');
            completeStep('step3'); activateStep('step4');
            btn.disabled = false; btn.textContent = 'üîÑ Update';
        }

        async function checkCollisions() {
            const btn = document.getElementById('checkBtn');
            btn.disabled = true; btn.textContent = '‚è≥...';
            setStatus('step4Status', 'info', '‚è≥ Checking...');
            await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'checkCollisions' }) });
            await new Promise(r => setTimeout(r, 5000));
            setStatus('step4Status', 'success', '‚úÖ Done!');
            completeStep('step4');
            document.getElementById('resultsSection').innerHTML = `<div class="results-box"><h2>üéâ Complete!</h2><a href="https://docs.google.com/spreadsheets/d/1omcWpajVrVMTWiOdKL5YQr40KxlRHCogJpfKuRUsdWY/edit?gid=808012596" target="_blank">üìä View Results</a></div>`;
            document.getElementById('resultsSection').style.display = 'block';
            btn.disabled = false; btn.textContent = 'üîç Run Again';
        }

        function setStatus(id, type, msg) {
            const el = document.getElementById(id);
            el.className = 'status ' + type;
            el.textContent = msg;
        }
        function completeStep(id) { document.getElementById(id).classList.remove('active'); document.getElementById(id).classList.add('complete'); }
        function activateStep(id) { document.getElementById(id).classList.add('active'); }
        function skipStep3() { setStatus('step3Status', 'warning', '‚è≠Ô∏è Skipped'); document.getElementById('step3').classList.remove('active'); activateStep('step4'); }

        const uploadZone = document.getElementById('uploadZone');
        const pdfInput = document.getElementById('pdfInput');
        uploadZone.onclick = () => pdfInput.click();
        uploadZone.ondragover = e => { e.preventDefault(); uploadZone.classList.add('dragover'); };
        uploadZone.ondragleave = () => uploadZone.classList.remove('dragover');
        uploadZone.ondrop = e => { e.preventDefault(); uploadZone.classList.remove('dragover'); if (e.dataTransfer.files[0]?.type === 'application/pdf') parsePDF(e.dataTransfer.files[0]); };
        pdfInput.onchange = e => { if (e.target.files[0]) parsePDF(e.target.files[0]); };
        
        fetchValidCourseCodes();
    </script>
</body>
</html>
