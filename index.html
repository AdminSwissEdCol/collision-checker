<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Collision Checker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #c8102e;
        }
        .header h1 { color: #c8102e; margin-bottom: 5px; font-size: 1.8em; }
        .header .subtitle { color: #666; font-size: 1.1em; }
        
        .step {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 5px solid #e0e0e0;
            transition: all 0.3s;
        }
        .step.active { border-left-color: #4285f4; }
        .step.complete { border-left-color: #34a853; background: #f8fff8; }
        .step.error { border-left-color: #ea4335; }
        
        .step-header { display: flex; align-items: center; margin-bottom: 15px; }
        .step-number {
            width: 36px; height: 36px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.1em;
            margin-right: 15px;
        }
        .step.active .step-number { background: #4285f4; color: white; }
        .step.complete .step-number { background: #34a853; color: white; }
        .step.complete .step-number::after { content: "‚úì"; }
        .step.complete .step-number span { display: none; }
        
        .step-title { font-size: 1.1em; font-weight: 600; color: #333; }
        .step-content { margin-left: 51px; }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            border: none;
            margin: 5px 5px 5px 0;
            transition: all 0.2s;
        }
        .btn-primary { background: #4285f4; color: white; }
        .btn-primary:hover { background: #3367d6; }
        .btn-success { background: #34a853; color: white; }
        .btn-success:hover { background: #2d8e47; }
        .btn-large { font-size: 16px; padding: 15px 30px; }
        .btn:disabled { background: #ccc !important; cursor: not-allowed; }
        
        .upload-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #4285f4;
            background: #e8f0fe;
        }
        .upload-zone input { display: none; }
        .upload-zone .icon { font-size: 2em; margin-bottom: 10px; }
        
        .status {
            margin: 10px 0;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 14px;
        }
        .status.info { background: #e8f0fe; color: #1967d2; }
        .status.success { background: #e6f4ea; color: #137333; }
        .status.error { background: #fce8e6; color: #c5221f; }
        .status.warning { background: #fef7e0; color: #b06000; }
        .status:empty { display: none; }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        .input-group input:focus {
            outline: none;
            border-color: #4285f4;
        }
        
        .stats { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .stat {
            background: #f1f3f4;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .results-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-top: 20px;
        }
        .results-box h2 { margin: 0 0 10px 0; }
        .results-box .count { font-size: 3em; font-weight: bold; margin: 15px 0; }
        .results-box a {
            display: inline-block;
            background: white;
            color: #667eea;
            padding: 12px 30px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 10px;
        }
        .results-box a:hover { transform: scale(1.05); }
        .results-box.no-collisions { background: linear-gradient(135deg, #34a853 0%, #0d652d 100%); }
        .results-box.no-collisions a { color: #34a853; }
        
        .info-box {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 12px 15px;
            border-radius: 0 6px 6px 0;
            margin: 15px 0;
            font-size: 13px;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
        }
        
        details summary { cursor: pointer; color: #666; font-size: 13px; margin: 10px 0; }
        
        .help-section {
            margin-top: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0;
        }
        .help-section summary {
            padding: 12px 15px;
            margin: 0;
            background: #f1f3f4;
            border-radius: 8px;
        }
        .help-section[open] summary {
            border-radius: 8px 8px 0 0;
        }
        .help-content {
            padding: 15px;
            font-size: 13px;
        }
        .help-content h4 {
            margin: 15px 0 8px 0;
            color: #333;
            font-size: 13px;
        }
        .help-content h4:first-child { margin-top: 0; }
        .help-content ul {
            margin: 0;
            padding-left: 20px;
        }
        .help-content li { margin: 4px 0; }
        .help-content code {
            background: #e8e8e8;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }
        .help-table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
        }
        .help-table td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top;
        }
        .help-table td:first-child {
            width: 140px;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .table-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-top: 10px;
        }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; }
        
        .level-badge {
            display: inline-block; padding: 2px 8px; border-radius: 10px;
            font-size: 10px; font-weight: 500;
        }
        .level-Certificate { background: #fce8e6; color: #c5221f; }
        .level-Diploma { background: #e8f0fe; color: #1967d2; }
        .level-High-Diploma { background: #fef7e0; color: #b06000; }
        .level-BBA { background: #e6f4ea; color: #137333; }
        .level-PGD { background: #f3e8fd; color: #7627bb; }
        .level-MBA { background: #fce8f4; color: #b80672; }
        
        @media (max-width: 600px) {
            .step-content { margin-left: 0; margin-top: 15px; }
            .input-group { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìö Course Collision Checker</h1>
        <p class="subtitle">Check if returning students have already taken their scheduled courses</p>
    </div>

    <!-- STEP 1: Upload PDF -->
    <div class="step active" id="step1">
        <div class="step-header">
            <div class="step-number"><span>1</span></div>
            <div class="step-title">Upload Timetable PDF</div>
        </div>
        <div class="step-content">
            <div class="upload-zone" id="uploadZone">
                <input type="file" id="pdfInput" accept=".pdf">
                <div class="icon">üìÑ</div>
                <p><strong>Drop PDF here</strong> or click to browse</p>
            </div>
            <div id="step1Status" class="status"></div>
            <div id="courseStats" class="stats"></div>
            
            <div id="sendCoursesSection" style="display: none; margin-top: 15px;">
                <button class="btn btn-success btn-large" onclick="sendCourses()" id="sendCoursesBtn">
                    üì§ Send Courses to Google Sheet
                </button>
            </div>
            
            <details id="courseDetails" style="display: none;">
                <summary>üìë View extracted courses</summary>
                <div class="table-container" id="courseTable"></div>
            </details>
            
            <details class="help-section" style="margin-top: 15px;">
                <summary>‚ùì PDF not working?</summary>
                <div class="help-content">
                    <h4>What this tool extracts:</h4>
                    <ul>
                        <li><strong>Course codes</strong> like <code>1022B</code>, <code>2040A</code> (4 digits + letter)</li>
                        <li><strong>Level</strong> from the page header (Certificate, Diploma, MBA, etc.)</li>
                    </ul>
                    <p>Course names come from the raw grade data, not the PDF.</p>
                    
                    <h4>If courses show "Unknown" level:</h4>
                    <p>The page header couldn't be detected. Verify the level manually in the Courses tab after sending.</p>
                    
                    <h4>Expected PDF format:</h4>
                    <p>Timetable PDFs from <strong>aSc Timetables</strong> with each page/section labeled by level in the header.</p>
                </div>
            </details>
        </div>
    </div>

    <!-- STEP 2: Import Students -->
    <div class="step" id="step2">
        <div class="step-header">
            <div class="step-number"><span>2</span></div>
            <div class="step-title">Import Class List</div>
        </div>
        <div class="step-content">
            <p>Paste the Google Sheet URL containing your class list:</p>
            <div class="input-group">
                <input type="text" id="studentsUrl" placeholder="https://docs.google.com/spreadsheets/d/xxxxx/edit#gid=0">
                <button class="btn btn-primary" onclick="importStudents()" id="importStudentsBtn">üì• Import</button>
            </div>
            <div id="step2Status" class="status"></div>
            
            <details class="help-section">
                <summary>‚ùì Help & Troubleshooting</summary>
                <div class="help-content">
                    <h4>Required columns:</h4>
                    <ul>
                        <li><strong>Class</strong> ‚Äî containing level info like <code>26-T1-Class-Certificate</code></li>
                        <li><strong>School Email</strong> ‚Äî student email addresses</li>
                    </ul>
                    
                    <h4>Common issues:</h4>
                    <table class="help-table">
                        <tr>
                            <td>‚ùå "Cannot access"</td>
                            <td>Sheet isn't shared. Click <strong>Share ‚Üí Anyone with link ‚Üí Viewer</strong></td>
                        </tr>
                        <tr>
                            <td>‚ùå "Invalid URL"</td>
                            <td>Copy the full URL from your browser address bar</td>
                        </tr>
                        <tr>
                            <td>‚ùå "Missing columns"</td>
                            <td>Make sure headers include "Class" and "Email" (case-insensitive)</td>
                        </tr>
                        <tr>
                            <td>‚ö†Ô∏è "Could not detect level"</td>
                            <td>Class column should have format like <code>26-T1-Class-Diploma</code></td>
                        </tr>
                    </table>
                    
                    <h4>Accepted column names:</h4>
                    <p><strong>For Class:</strong> Class, Student Class, Level, Program</p>
                    <p><strong>For Email:</strong> School Email, Email, Student Email, E-mail</p>
                </div>
            </details>
        </div>
    </div>

    <!-- STEP 3: Update Raw Data -->
    <div class="step" id="step3">
        <div class="step-header">
            <div class="step-number"><span>3</span></div>
            <div class="step-title">Update Historical Grade Data</div>
        </div>
        <div class="step-content">
            <p>Import the latest grade records from the nightly backup:</p>
            <button class="btn btn-primary" onclick="updateRaw()" id="updateRawBtn">üîÑ Update Raw Data</button>
            <button class="btn" style="background: #f1f3f4; color: #333;" onclick="skipStep3()" id="skipStep3Btn">Skip (use existing) ‚Üí</button>
            <div id="step3Status" class="status"></div>
            
            <div class="info-box">
                <strong>‚ö†Ô∏è Required on first use</strong> or if grades have changed.<br>
                <span style="color: #666;">Skip only if you've already updated raw data recently. The backup updates nightly at 3:00 AM.</span>
            </div>
        </div>
    </div>

    <!-- STEP 4: Check Collisions -->
    <div class="step" id="step4">
        <div class="step-header">
            <div class="step-number"><span>4</span></div>
            <div class="step-title">Check for Collisions</div>
        </div>
        <div class="step-content">
            <p>Run the collision check to find students who have already taken their scheduled courses:</p>
            <button class="btn btn-success btn-large" onclick="checkCollisions()" id="checkBtn">üîç Check for Collisions</button>
            <div id="step4Status" class="status"></div>
            
            <details class="help-section" style="margin-top: 15px;">
                <summary>‚ùì How collision detection works</summary>
                <div class="help-content">
                    <h4>What counts as a collision?</h4>
                    <p>A student has a <strong>collision</strong> if they have at least one <strong>actual grade recorded</strong> (non-empty "Contribution %") for a scheduled course.</p>
                    <ul>
                        <li>Students enrolled but with <strong>no grades</strong> ‚Üí NOT a collision</li>
                        <li>Students with <strong>0% grade</strong> ‚Üí IS a collision (0 is still a grade)</li>
                        <li>Students with <strong>any grade value</strong> ‚Üí IS a collision</li>
                    </ul>
                    
                    <h4>Grade calculation:</h4>
                    <p>The grade shown is the <strong>SUM</strong> of all "Contribution %" values for each student+course+session.</p>
                    
                    <h4>Quick filters:</h4>
                    <p>In Google Sheets, use <strong>Collision Checker ‚Üí Quick Filters</strong> to instantly filter:</p>
                    <ul>
                        <li>‚ö†Ô∏è 0-59% (Insufficient)</li>
                        <li>‚úì 60-100% (Passed)</li>
                        <li>Show All</li>
                    </ul>
                    
                    <h4>Filtering results:</h4>
                    <p>Each column header (row 4) has a dropdown filter. Click to filter by level, course, grade, etc.</p>
                    <p><strong>To save a filter:</strong> In Google Sheets, go to <em>Data ‚Üí Filter views ‚Üí Create new filter view</em>.</p>
                    
                    <h4>Color coding in results:</h4>
                    <table class="help-table">
                        <tr>
                            <td style="background: #fef7e0;">‚ö†Ô∏è Orange</td>
                            <td>Total grade <60% - insufficient, may need academic review</td>
                        </tr>
                        <tr>
                            <td style="background: #fce8e6;">‚úì Red</td>
                            <td>Total grade ‚â•60% - passed, cannot retake course</td>
                        </tr>
                    </table>
                    
                    <h4>If results are unexpected:</h4>
                    <ul>
                        <li>Check that course codes match exactly (e.g., <code>2040A</code> vs <code>2040B</code>)</li>
                        <li>Verify student emails are identical in both the class list and raw data</li>
                        <li>Ensure raw data is current (click "Update Raw Data" in Step 3)</li>
                    </ul>
                    
                    <h4>Want to check manually?</h4>
                    <p>Open the <a href="https://docs.google.com/spreadsheets/d/1omcWpajVrVMTWiOdKL5YQr40KxlRHCogJpfKuRUsdWY/edit" target="_blank">full spreadsheet</a> to see all tabs.</p>
                </div>
            </details>
        </div>
    </div>

    <!-- Results -->
    <div id="resultsSection" style="display: none;"></div>

    <div class="footer">
         ‚Ä¢ Course Collision Checker ‚Ä¢<br>
        <small>Support : administration@ </small>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzD-Fsbe8g4eXlwIE-VYpOFIxCftbchaxyYXafgWRfn7nzLz3n7feLo6G8zXqx14eb2/exec';
        
        let extractedCourses = [];
        let pdfFileName = '';

        // ========== PDF PARSING ==========
        
        // Course code pattern: 4 digits + letter (e.g., 1022B, 2040B)
        // Also matches C-prefixed coursework codes (C2060B)
        const COURSE_CODE_PATTERN = /\b(C?)(\d{4})\s*\(?([A-Z])\)?/gi;
        
        // Patterns that indicate self-study or coursework version
        const COURSEWORK_PATTERNS = [
            /self\s*study/i,
            /self-study/i,
            /coursework/i,
            /course\s*work/i,
            /\bSS\b/,  // Common abbreviation
        ];

        function isCourseworkContext(text, codePosition) {
            // Check ~100 chars before and after the code for coursework indicators
            const start = Math.max(0, codePosition - 100);
            const end = Math.min(text.length, codePosition + 100);
            const context = text.substring(start, end);
            
            for (const pattern of COURSEWORK_PATTERNS) {
                if (pattern.test(context)) {
                    return true;
                }
            }
            return false;
        }

        function extractCourseName(text, code) {
            // Course names will come from raw data - just return empty here
            return '';
        }

        function detectLevel(pageText) {
            // Check first 200 chars for level (title area only)
            const header = pageText.substring(0, 200).toUpperCase();
            
            // Check CUL variants first (most specific)
            if (header.includes('CUL II')) return 'CUL II';
            if (header.includes('CUL I') && !header.includes('CUL II')) return 'CUL I';
            
            // Check other levels
            if (header.includes('HIGH DIPLOMA')) return 'High Diploma';
            if (header.includes('DIPLOMA') && !header.includes('HIGH')) return 'Diploma';
            if (header.includes('CERTIFICATE')) return 'Certificate';
            if (header.includes('MBA')) return 'MBA';
            if (header.includes('BBA')) return 'BBA';
            if (header.includes('PGD')) return 'PGD';
            if (header.includes('ENGLISH')) return 'English';
            
            return 'Unknown';
        }

        async function parsePDF(file) {
            setStatus('step1Status', 'info', '‚è≥ Processing PDF...');
            pdfFileName = file.name; // Store filename
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                const allCourses = new Map();
                const levelStats = {};

                for (let i = 1; i <= pdf.numPages; i++) {
                    setStatus('step1Status', 'info', `‚è≥ Processing page ${i} of ${pdf.numPages}...`);
                    
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    
                    const level = detectLevel(pageText);
                    
                    // Find all course codes with position info
                    let match;
                    const courseCodesFound = new Map(); // code -> {isCoursework, positions}
                    
                    // Reset regex
                    COURSE_CODE_PATTERN.lastIndex = 0;
                    
                    while ((match = COURSE_CODE_PATTERN.exec(pageText)) !== null) {
                        const existingPrefix = match[1] || ''; // Already has C?
                        const digits = match[2];
                        const letter = match[3].toUpperCase();
                        const position = match.index;
                        
                        // Check if this occurrence is in a coursework/self-study context
                        const isCoursework = existingPrefix === 'C' || isCourseworkContext(pageText, position);
                        
                        // Build the code
                        const baseCode = digits + letter;
                        const finalCode = isCoursework ? 'C' + baseCode : baseCode;
                        
                        if (!courseCodesFound.has(finalCode)) {
                            courseCodesFound.set(finalCode, { isCoursework });
                        }
                    }
                    
                    for (const [code, info] of courseCodesFound) {
                        const name = extractCourseName(pageText, code);
                        if (!allCourses.has(code)) {
                            allCourses.set(code, { name, levels: new Set() });
                        } else if (name && !allCourses.get(code).name) {
                            allCourses.get(code).name = name;
                        }
                        if (level !== 'Unknown') {
                            allCourses.get(code).levels.add(level);
                        }
                    }
                }

                extractedCourses = [];
                allCourses.forEach((data, code) => {
                    const levels = data.levels.size > 0 ? [...data.levels] : ['Unknown'];
                    for (const level of levels) {
                        extractedCourses.push({ code, name: data.name || '', level });
                        levelStats[level] = (levelStats[level] || 0) + 1;
                    }
                });
                extractedCourses.sort((a, b) => a.level.localeCompare(b.level) || a.code.localeCompare(b.code));

                // Display stats
                document.getElementById('courseStats').innerHTML = Object.entries(levelStats)
                    .map(([level, count]) => `<div class="stat"><strong>${level}:</strong> ${count}</div>`).join('');
                
                // Count coursework courses
                const courseworkCount = extractedCourses.filter(c => c.code.startsWith('C')).length;
                
                // Display table - names come from raw data later
                let html = '<table><thead><tr><th>Code</th><th>Level</th><th>Type</th></tr></thead><tbody>';
                for (const c of extractedCourses) {
                    const levelClass = 'level-' + c.level.replace(/\s+/g, '-');
                    const isCoursework = c.code.startsWith('C');
                    const typeLabel = isCoursework 
                        ? '<span style="color: #666; font-size: 11px;">üìö Self Study</span>'
                        : '<span style="color: #137333; font-size: 11px;">‚úì Regular</span>';
                    const codeStyle = isCoursework ? 'color: #666;' : '';
                    html += `<tr><td><strong style="${codeStyle}">${c.code}</strong></td><td><span class="level-badge ${levelClass}">${c.level}</span></td><td>${typeLabel}</td></tr>`;
                }
                html += '</tbody></table>';
                
                let infoMsg = '<p style="font-size: 11px; color: #666; margin-top: 8px;">‚ÑπÔ∏è Course names will be added from grade records.</p>';
                if (courseworkCount > 0) {
                    infoMsg += `<p style="font-size: 11px; color: #666;">üìö ${courseworkCount} Self Study/CourseWork course(s) detected (C-prefixed). These won't trigger collisions unless in raw data.</p>`;
                }
                document.getElementById('courseTable').innerHTML = html + infoMsg;
                
                document.getElementById('sendCoursesSection').style.display = 'block';
                document.getElementById('courseDetails').style.display = 'block';
                
                setStatus('step1Status', 'success', `‚úÖ Extracted ${extractedCourses.length} courses from ${pdf.numPages} pages`);
                
            } catch (error) {
                setStatus('step1Status', 'error', `‚ùå Error: ${error.message}`);
            }
        }

        // ========== API CALLS ==========
        
        async function sendCourses() {
            if (!extractedCourses || extractedCourses.length === 0) {
                setStatus('step1Status', 'error', '‚ö†Ô∏è No courses extracted. Please upload a PDF first.');
                return;
            }
            
            const btn = document.getElementById('sendCoursesBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Sending...';
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);
                
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'importCourses', 
                        courses: extractedCourses,
                        pdfName: pdfFileName
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                // Check for unknown levels
                const unknownCount = extractedCourses.filter(c => c.level === 'Unknown').length;
                if (unknownCount > 0) {
                    setStatus('step1Status', 'warning', `‚ö†Ô∏è ${extractedCourses.length} courses sent, but ${unknownCount} have "Unknown" level. You may want to check the Courses tab.`);
                } else {
                    setStatus('step1Status', 'success', `‚úÖ ${extractedCourses.length} courses sent to Google Sheet!`);
                }
                
                completeStep('step1');
                activateStep('step2');
                btn.textContent = '‚úÖ Sent!';
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    setStatus('step1Status', 'error', '‚ö†Ô∏è Request timed out. Please try again.');
                } else {
                    setStatus('step1Status', 'error', '‚ùå Network error. Check your internet connection.');
                }
                btn.textContent = 'üì§ Send Courses to Google Sheet';
                btn.disabled = false;
            }
        }
        
        async function importStudents() {
            const url = document.getElementById('studentsUrl').value.trim();
            
            // Client-side validation
            if (!url) {
                setStatus('step2Status', 'error', '‚ö†Ô∏è Please paste a Google Sheet URL');
                return;
            }
            
            // Check if it looks like a Google Sheets URL
            const isGoogleUrl = url.includes('docs.google.com/spreadsheets') || 
                               url.includes('sheets.google.com') ||
                               url.match(/^[a-zA-Z0-9-_]{20,}$/); // Just the ID
            
            if (!isGoogleUrl) {
                setStatus('step2Status', 'error', '‚ö†Ô∏è This doesn\'t look like a Google Sheets URL. Please copy the full URL from your browser.');
                return;
            }
            
            const btn = document.getElementById('importStudentsBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥...';
            setStatus('step2Status', 'info', '‚è≥ Importing students... (this may take a few seconds)');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout
                
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'importStudents', url }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                // With no-cors we can't read response, wait and assume success
                await new Promise(r => setTimeout(r, 3000));
                
                setStatus('step2Status', 'success', '‚úÖ Import request sent! If your sheet was shared correctly, students are now imported. Check Step 4 for any errors.');
                completeStep('step2');
                activateStep('step3');
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    setStatus('step2Status', 'error', '‚ö†Ô∏è Request timed out. The server may be busy - please try again.');
                } else {
                    setStatus('step2Status', 'error', '‚ùå Network error. Check your internet connection and try again.');
                }
            }
            
            btn.disabled = false;
            btn.textContent = 'üì• Import';
        }
        
        async function updateRaw() {
            const btn = document.getElementById('updateRawBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Updating...';
            setStatus('step3Status', 'info', '‚è≥ Fetching latest backup... This may take 10-30 seconds for large files.');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60s for large CSV
                
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'updateRaw' }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                await new Promise(r => setTimeout(r, 5000));
                
                setStatus('step3Status', 'success', '‚úÖ Raw data updated from latest backup!');
                completeStep('step3');
                activateStep('step4');
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    setStatus('step3Status', 'warning', '‚ö†Ô∏è Request timed out, but it may still be processing. Try running the collision check.');
                } else {
                    setStatus('step3Status', 'error', '‚ùå Network error. Check your internet connection.');
                }
            }
            
            btn.disabled = false;
            btn.textContent = 'üîÑ Update Raw Data';
        }
        
        async function checkCollisions() {
            const btn = document.getElementById('checkBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Checking...';
            setStatus('step4Status', 'info', '‚è≥ Running collision check... This may take 10-20 seconds for large datasets.');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60s timeout for large datasets
                
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'checkCollisions' }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                // Wait for processing
                await new Promise(r => setTimeout(r, 5000));
                
                setStatus('step4Status', 'success', '‚úÖ Collision check complete! Click the button below to view results.');
                completeStep('step4');
                
                // Show results link
                document.getElementById('resultsSection').innerHTML = `
                    <div class="results-box">
                        <h2>üéâ Check Complete!</h2>
                        <p>View the results in Google Sheets:</p>
                        <a href="https://docs.google.com/spreadsheets/d/1omcWpajVrVMTWiOdKL5YQr40KxlRHCogJpfKuRUsdWY/edit?gid=808012596#gid=808012596" target="_blank">
                            üìä Open Results Tab
                        </a>
                        <p style="margin-top: 15px; font-size: 13px; opacity: 0.9;">
                            <strong>Orange rows</strong> = collision with insufficient grade (<60%)<br>
                            <strong>Red rows</strong> = collision with passing grade (‚â•60%)<br>
                            <strong>Tip:</strong> Use column filters (row 4) to show/hide results. Create a <em>Filter View</em> to save your filter settings.
                        </p>
                    </div>
                `;
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    setStatus('step4Status', 'error', '‚ö†Ô∏è Request timed out. The dataset may be very large. Check the Results tab anyway - it may have completed.');
                } else {
                    setStatus('step4Status', 'error', '‚ùå Network error. Check your internet connection and try again.');
                }
                btn.disabled = false;
                btn.textContent = 'üîç Check for Collisions';
                return;
            }
            
            btn.disabled = false;
            btn.textContent = 'üîç Run Again';
        }

        // ========== HELPERS ==========
        
        function setStatus(id, type, message) {
            const el = document.getElementById(id);
            el.className = 'status ' + type;
            el.textContent = message;
        }
        
        function completeStep(stepId) {
            document.getElementById(stepId).classList.remove('active');
            document.getElementById(stepId).classList.add('complete');
        }
        
        function activateStep(stepId) {
            document.getElementById(stepId).classList.add('active');
        }
        
        function skipStep3() {
            setStatus('step3Status', 'warning', '‚è≠Ô∏è Skipped ‚Äî using existing raw data. If collision check fails, come back and update.');
            document.getElementById('step3').classList.remove('active');
            activateStep('step4');
        }

        // ========== FILE UPLOAD ==========
        
        const uploadZone = document.getElementById('uploadZone');
        const pdfInput = document.getElementById('pdfInput');

        uploadZone.addEventListener('click', () => pdfInput.click());
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files[0]?.type === 'application/pdf') parsePDF(e.dataTransfer.files[0]);
        });
        pdfInput.addEventListener('change', (e) => { if (e.target.files[0]) parsePDF(e.target.files[0]); });
    </script>
</body>
</html>
